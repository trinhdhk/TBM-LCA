# Methods

## Participants

We used data from an observational study of brain infection conducted on the neuro-infection ward of the Hospital for Tropical Diseases (HTD), Ho Chi Minh City, Vietnam. HTD is a 550-bed centre providing secondary and tertiary treatment for a wide range of tropical infections from all of southern Vietnam7. The study received ethical approvals from HTD and the Oxford Tropical Research Ethics Committee8. Participants were enrolled between 29th August 2017 and 22nd January 2021. Inclusion criteria included a minimum age of 16 years, having suspected brain infection of any cause, and undergoing lumbar puncture at baseline as a routine diagnostic procedure. Patients were ineligible for enrolment if performing a lumbar puncture was contraindicated, or if informed consent to join the study was not given (by the patient, or by a relative if the patient lacked capacity to consent). Specifically for this analysis, we also excluded patients with contaminated mycobacterial culture results and with no subsequent culture in the first week since admission.

## Data collection and testing procedures

At enrolment time, demographic information and medical history of participants were collected. HIV testing was performed on a case-by-case basis by the treating clinicians. Patients were tested for HIV if they presented with a condition suggestive of immune deficiency (e.g. tuberculosis, or cryptococcal meningitis) or had been involved in activities that increased HIV risk (e.g. injecting drug use). Patients with either known previous HIV infection and on anti-retroviral treatment, or a new positive HIV test result, were considered HIV positive. Patients underwent clinical examination and laboratory investigations, but no imaging session, according to the study protocol, including blood tests, sputum ZN staining, and lumbar puncture, unless contra-indicated, with routine CSF analysis including white blood cells and cellular differential, CSF protein, CSF glucose (with paired blood glucose), and CSF lactate. Ideally at least 6mls CSF was used for mycobacterial testing by Ziehl--Neelsen (ZN) stain, mycobacterial culture using Mycobacteria Growth Indicator Tube (MGIT), and Xpert or Xpert MTB/RIF Ultra (XpertUltra). Since Xpert and XpertUltra were found diagnostically comparable in a subset of these data[@donovan2020], they were considered the same in this analysis and, are both denoted as Xpert. Repeated CSF sampling and mycobacterial testing was performed if TBM was suspected by the treating clinician. If CSF was repeatedly sampled (performed based on clinical need), only the first sample with at least 3mls of CSF collected, not later than the first week since admission, were used. 

Methods of CSF processing have been described elsewhere[@nhu2013, @donovan2020]. Briefly: CSF samples were centrifuged at 3000g for 15 minutes, and most of the CSF supernatant was removed. The CSF deposit was resuspended in 500µL of remaining supernatant, with this resuspended pellet then used for ZN smear (100µL), MGIT (200µL), and either Xpert or XpertUltra (200 µL). 

Laboratory tests for differential diagnoses routinely used were Gram stain for other bacterial meningitis, eosinophilic cell count in the CSF as an indicator for eosinophilic meningitis, Indian-ink stain or CSF lateral flow antigen providing confirmatory evidence for Cryptococcal meningitis. 

All patients with confirmed or suspected TBM received 4-drug anti-TB chemotherapy regimens according to national and local treatment guidelines. At the time of discharge or death, all patients received a final diagnosis. If at least one of ZN Smear, Xpert, Xpert Ultra, or MGIT was positive from CSF at any time during the follow-up, the patient was considered to have confirmed TBM. Otherwise, if TBM was clinically suspected and treated, with confirmatory microbiological and molecular tests negative, the patient was considered to have suspected TBM. If the patient recovered without anti-TB chemotherapy, or an alternative diagnosis was confirmed microbiologically, they were reassigned to another diagnosis (i.e. not TBM).

## Statistical analysis

We conducted a Bayesian Latent Class Model in which the three aforementioned TBM confirmatory tests (ZN Smear, MGIT, and Xpert) were used as manifest variables. As all three tests are tool to detect bacteria existence in the sample under similar principle but via different methods: direct visualisation under microscope (ZN Smear), looking for their DNA (Xpert), or nurturing their culture (MGIT), our target latent class was the actual disease status (TBM or not TBM). Predictors for the latent class were chosen according to background knowledge of potential risk factors[@marais2010]. As discussed in section\ref(@data-collection-and-testing-procedures), we added three differential diagnosis indicators: (1) CSF eosinophil count - a strong bio-marker for eosinophilic meningitis, a relatively common condition in Vietnam, usually caused by *Angiostrongylus cantonensis*; (2) CSF lateral flow antigen/Indian Ink tests for cryptococcal meningitis; and (3) CSF Gram stain for non-acid-fast bacterial meningitis. Also added was CSF red cell count whose high numbers being a marker of traumatic lumbar puncture requiring corrections to white cell counts and biochemical features[@greenberg2008; @nigrovic2011; @mehl1986]. Details of the model design are provided in the supplementary document.

```{r predictor-tab, eval=FALSE, based on prior knowledge. Cell values are the expected direction of association and level of confidence; empty cells mean no association assumed", tab.id="predictor-tab", include=FALSE, label='tab0', out.width="100%", tab.cap="Anticipated contribution of demographic and clinical features to the likelihood of TBM and CSF mycobacterial burden for each model mentioned in table \\@ref(tab:model-archs)}
tibble::tribble(
  ~ 'Predictor'                    , ~ 'TBM prevalence', ~ 'Bacillary Burden',
  'Age'                            , '+, weak'  , ''                  ,
  'HIV infection'                  , '+, strong', '+, strong'         ,
  'Past TB contact'                , '+, weak'  , ''                  ,
  'TB-suggested symptoms'          , '+, weak'  , ''                  ,
  'Local motor deficit'            , '+, weak'  , ''                  ,         
  'Cranial nerve palsy'            , '+, weak'  , ''                  ,
  'Days from onset'                , '+, weak'  , ''                  ,
  'PTB/X-Ray'                      , '+, weak'  , ''                  ,
  'MTB/X-Ray'                      , '+, strong', ''                  ,
  'Glasgow Coma Score'             , '-, weak'  , ''                  ,
  'Cryptococcus Antigen/Indian Ink', '-, strong', ''                  ,
  'Blood Glucose'                  , '-, weak'  , ''                  ,
  'CSF Glucose'                    , '-, weak'  , '?, weak'     ,
  'CSF Lymphocyte Count'           , '+, weak'  , '-, weak'    ,
  'CSF Total While cell Count'     , '+-^[Risk of TBM peaks with intermediate CSF white cell count], weak' , '+, weak'    ,
  'CSF Protein'                    , '+, weak'  , '+, weak'    ,
  'CSF Lactate'                    , '+, weak'  , '+, weak'    ,
  'CSF Eosinophil Count'           , '-, strong', ''                  ,
  'CSF RBC Count'                  , '?, weak'   , ''                 
) |>
  flextable::flextable() |>
  ftExtra::colformat_md(2) |>
  # flextable::footnote(i=16, j=2, 
    # value=flextable::as_paragraph('')) |>
  flextable::width(j=1, width=2) |>
  flextable::width(j=2:3, width=1.2) |>
  flextable::theme_zebra() |>
  flextable::bold(bold = FALSE, part = "footer") |>
  flextable::italic(italic = TRUE, part = "footer" )
```

```{aligned_formula eval=FALSE, fml.lab='eq:fml-gcs', include=FALSE, results='asis'}
\begin{aligned}
RGCS &= 15 - GCS \\
RGCS_{Eyes} &= 4 - GCS_{Eyes} \\
RGCS_{Verbal} &= 5 - GCS_{Verbal} \\
RGCS_{Motor} &= 6 - GCS_{Motor}
\end{aligned}
```

As most continuous variables were right-skewed, they were first transformed to logarithmic scale, after which they were centred and divided by corresponding standard deviations. Compared to the uniform case definition, we also made a change to *Past TB contact*. We hypothesised that by interpreting the original question "contact with TB patients within the past year" into "*noticeable* contact with TB patients within the past year", we would be able to interpret all "Unknown" answer as a "No". No brain imaging was taken in our data.

<!-- Glasgow Coma Score (GCS) and Glasgow Coma Scale components (Voice - GCSV, Eyes - GCSE, and Muscle - GCSM) were translated to *Reversed GCS* as demonstrated in formula `r my_fn$labEq.docx('fml-gcs')`, so that a GCS of 15 is equal to a RGCS of 0 and a GCS of 3 is equal to RGCS of 12. Binary variables were dummy-coded into 0 for "Negative"/"No" and 1 for "Positive"/"Yes". -->

```{r gcs-tab, eval=FALSE, include=FALSE, out.width='100%', tab.cap='Conversion table from clasic Glasgow Coma Score (GCS) to Reversed GCS (RGCS)', tab.id='gcs-tab'}

tibble::tribble(
  ~ Feature,                     ~ Response, ~ GCS, ~ RGCS,
  'Eye response',        'Open sponatenously', 4, 0,
  'Eye response',     'Open to voice command', 3, 1,
  'Eye response',              'Open to pain', 2, 2,
  'Eye response',               'No eye open', 1, 3,
  'Verbal response',             'Orientated', 5, 0,
  'Verbal response',               'Confused', 4, 1,
  'Verbal response',     'Inappopriate words', 3, 2,
  'Verbal response','Incomprehensible sounds', 2, 3,
  'Verbal response',     'No verbal response', 1, 4,
  'Motor response',            'Obey command', 6, 0,
  'Motor response',         'Localising pain', 5, 1,
  'Motor response',    'Withdrawal from pain', 4, 2,
  'Motor response',                 'Flexing', 3, 3,
  'Motor response',               'Extending', 2, 4,
  'Motor response',       'No motor response', 1, 5
) |>
  flextable::flextable() |>
  flextable::merge_v(j = 1) |>  
  flextable::width(j=1, width=2) |>
  flextable::width(j=2, width=2)
```

```{r model-archs, eval=FALSE, include=FALSE, tab.cap="Model architectures and extensions", tab.id="model-archs"}
model_archs <-
  data.frame(
    Model=1:5,
    Def=c(
      'No bacillary burden; everyone in the same class has equal risk of tested positive',
      'Added individual bacillary burden; impacts of bacillary burden on test results are the same',
      'Impacts of bacillary burden are different for different tests',
      'Added technical fluctuation as a second random effect; fixed effects only contributes to bacillary burden',
      'Added fixed effects for technical fluctuation'
    )
  ) 

model_archs |> 
  flextable::flextable() |>
  flextable::set_header_labels(
    Model='Model', 
    Def='Base definition (Only added effects compared to lower number are mentioned)'
  ) |>
  flextable::width(j=1, width=.5)|>
  flextable::width(j=2, width=5) |>
  flextable::theme_zebra()
```

The basic design of our model is shown in figure \@ref(fig:skeleton-model). Our models consist of one logistic regression estimating the prevalence of TBM in the population (prevalence model) and linear regression estimating the latent bacillary burden among TBM positive patients (bacillary burden model), which in turn contribute the the confirmatory test results. We considered several model complexity[@schumacher2016], and detailed them in the supplementary document. 

```{r skeleton-model, fig.show='hold', out.width="100%", fig.align="center", fig.cap="Model basic design. Bacillary burden is only included in model 2 +. Test positive probabilities are for demonstration only and do not correspond to the real ones.", fig.id='skeleton-model'}

fig_svg <- cowplot::ggdraw() + 
  cowplot::draw_image(magick::image_read_svg("includes/classicLCA.svg", width=212*5, height=159*5))
plot(fig_svg)
```

By protocol, most patients likely or evidently diagnosed with different diseases did not have TBM confirmation assays done. In those cases, test results were missing. However, as these tests are known to have high specificity[@nhu2013, @heemskerk2018], we assumed that they were all negative. These assumptions will be tested by sensitivity analyses, as discussed in the supplementary document. Missing predictors were handled case by case basing on their expected missing mechanisms (table \@ref(tab:missing-handling)). In case they were expected to be Missing At Random (MAR), we performed a model-based imputation.

We used Bayesian approach for estimation. For TBM confirmatory test sensitivity and specificity, sufficient prior distributions capturing past estimates from earlier studies involving Vietnamese cohorts[@thwaites2004; @nhu2013; @heemskerk2018] were used. Weakly informative prior distributions were utilised for all coefficients. 

All model performances were estimated and compared by (1) expected log point-wise predictive density (elpd) - quantifying how good the model predicting unseen data [@vehtari2016], (2) calibration metrics and calibration curves[@rms; @VanCalster2019], and (3) Receiver Operating Characteristic (ROC) curves and corresponding Area Under the Curve (AUC). All metrics were estimated using a pooled dataset held out from 5 repetitions of 20-fold cross validation. We also used the clinician's diagnoses at discharge (if available) as a pseudo-gold standard to visualise the correlation of our model-based prediction and delayed clinical diagnosis. 

```{r mv-priors, eval=FALSE, fig.align='center', fig.cap="Density plots for prior distributions and their adherence to prior knowledge of sensitivity and specificity for TBM confirmation tests, fig.height=8, fig.id="mv-priors", against then-made clinical diagnosis. Note that Thwaites 2004 was descriptive only while ZN and Culture in Nhu 2013 were references hence no Confidence Interval", warning=FALSE, dpi=300, include=FALSE, out.width='90%'}
sen_tbl <-
  tibble::tibble(
    'Test' = rep(c('ZN', 'Culture', 'Xpert'), 3),
    'Study' = rep(c('Thwaites 2004', 'Nhu 2013', 'Heemskerk 2018'), each=3),
    'est' = c(58/100, 64/100, NA, 78.64/100, 66.54/100, 59.34/100, 34.54/100, 31.84/100, 25.14/100),
    'lower.ci' = c(NA, NA, NA, 71.94/100, 59.14/100, 51.84/100, 29.94/100, 27.34/100, 21.04/100),
    'upper.ci' = c(NA, NA, NA, 84.34/100, 73.34/100, 66.54/100, 39.44/100, 36.74/100, 29.74/100)
  )

spc_tbl <-
  tibble::tibble(
    'Test' = rep(c('ZN', 'Culture', 'Xpert'), 3),
    # Test_id = rep(c(3,1,2), 2),
    'Study' = rep(c('Thwaites 2004','Nhu 2013', 'Heemskerk 2018'), each=3),
    'est' = c(NA, NA, NA, 0, 0, 0.05/100, 0, 0, 0),
    'upper.ci' = c(NA, NA, NA, NA, NA, (100-97.2)/100, (100-97.1)/100, (100-96.9)/100, (100-96.1)/100),
    'lower.ci' = c(NA, NA, NA, NA, NA, 0, 0, 0, 0)
  )

spc_rng = rbind(
  data.frame(
    Test = 'ZN',
    Test_id = 1,
    logit = rlogis(1000000,qlogis(.001),1.1),
    linear = rlogis(1000000,qlogis(.001),1.1) |> plogis()
  ),
  data.frame(
    Test = 'Culture',
    Test_id = 2,
    logit = rlogis(1000000,qlogis(.001),1.1),
    linear = rlogis(1000000,qlogis(.001),1.1) |> plogis()
  ),
  data.frame(
    Test = 'Xpert',
    Test_id = 3,
    logit = rlogis(1000000,qlogis(.005),.7),
    linear = rlogis(1000000,qlogis(.005),.7) |> plogis()
  )
) |>
  filter(linear<.1)
  

sen_rng = rbind(
  data.frame(
    Test = 'ZN',
    Test_id = 1,
    logit = rlogis(500000, 0,.3),
    linear = rlogis(500000, 0,.3) |> plogis()
  ),
  data.frame(
    Test = 'Culture',
    Test_id = 2,
     logit = rlogis(500000, 0,.3),
    linear = rlogis(500000, 0,.3) |> plogis()
  ),
  data.frame(
    Test = 'Xpert',
    Test_id = 3,
    logit = rlogis(500000, 0,.3),
    linear = rlogis(500000, 0,.3) |> plogis()
  )
) 

spc_linear_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=linear), data=spc_rng) +
  geom_point(aes(y= est, color = Study, x = -.2), data=spc_tbl, position=position_dodge(.2), shape=18, size=3) + 
  geom_linerange(aes(ymin = lower.ci, ymax = upper.ci, color = Study, x = -.2), data=spc_tbl, position=position_dodge(.2)) +
  coord_flip(ylim=c(0,.05))+
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  scale_color_discrete(drop=FALSE)+
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

spc_logit_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=logit), data=spc_rng) +
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  coord_flip(ylim=c(-15, 2.5)) +
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

sen_linear_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=linear), data=sen_rng) +
  geom_point(aes(y= est, color = Study, x = -.2), data=sen_tbl, position=position_dodge(.2), shape=18, size=3) + 
  geom_linerange(aes(ymin = lower.ci, ymax = upper.ci, color = Study, x = -.2), data=sen_tbl, position=position_dodge(.2)) +
  coord_flip()+
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

sen_logit_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=logit), data=sen_rng) +
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
  

plt <- (spc_linear_plt + ggtitle('FPR (1-Specificity)') + theme(legend.position = "none") | spc_logit_plt) /
  (sen_linear_plt + ggtitle('TPR (Sensitivity)') + theme(legend.position = "bottom") | sen_logit_plt) 

for (i in 1:2) plt[[i]] <- plt[[i]] + plot_layout(tag_level = 'new')
color_me <- list("#000000", "#E69F00", "#56B4E9", c("#000000", "#E69F00", "#56B4E9", "#009E73"))
withr::with_options(
  list(ggplot2.discrete.colour = color_me),

  plt + plot_annotation(tag_levels = list(c('',''), 'A'), caption='A: Linear scale, B: Logistic Scale \n Black dots, thick lines and thin lines are median, IQR, and 95% inter-percentile range') + plot_layout(guides = 'collect') & theme(text = element_text('serif', size = 9), plot.tag = element_text('serif', size = 9), legend.position = "bottom") 
)
```

<!--Since latent class analysis models unobserved characteristics, results may be strongly dependent on our assumptions. Therefore, we conducted sensitivity analyses where some assumptions were lifted or changed. We first increased the standard deviation of our prior for specificities of all confirmatory tests so that every value in the range of 90%-100% were accepted. We also changed the prior distributions of the parameters in the prevalence and bacillary burden models from *normal* to a more skeptical one *Student's t* with 4 degrees of freedom; means and scales, however, were kept as-is. Their *elpd*s were compared. Thirdly, as recent studies suggested a sup-optimal specificity of Xpert test on CSF samples [@nhu2013; @chen2020], we considered a Missing-At-Random scenario, where observation chance of confirmation tests depend on the unknown TBM status and locally independent to the value of confirmation tests. Observation status was then included in the model as a separated manifest variables. We visualised the estimates of this model with the best performing one in our main analysis.

Furthermore, to explore hidden effects, we added quadratic terms for all five CSF bio-markers and RGCS to the prevalence model; CSF volume was additionally included to capture its potential impact on test sensitivity. *Laplace* priors were utilised instead of *Normal* for all linear covariates. Posteriors and performance metrics of this model were reported.-->

We lastly transferred the posterior estimates of individual risk of TBM from the best performing model to a simplified logistic regression that excluded laboratory variables and analyse whether the estimated latent probabilities approximate those from the prevalence model above. Similar weakly informative prior distributions were imposed for all coefficients.

All data preparation, cleaning, and processing were performed on statistical package R, version 4.1.1 [@rcoreteam]. Posterior distributions were obtained via Hamiltonian Markov Chain Monte Carlo with 8000 effective iterations in each of 4 chains, using the Stan program and its R interface in the RStan[@stan-doc] package, version 2.27[@stan].Convergence and effectiveness of MCMC chains were evaluated by Brooks-Gelman-Rubin statistic ($\hat{R}$) and Effective Sample size[@stan-doc]. Plotting was done using package bayesplot [@bayesplot], classifierplots [@classifierplots], and ggvenn [@ggvenn]. Some other packages used include: R6 [@r6] and rms [@rms]. Mathematical formulations and technical adjustments were detailed in the supplementary documents. All code were published on [project's github repo](github.com/TBM-LCA).

