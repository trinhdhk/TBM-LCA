# Methods

## Participants

This analysis was performed using data from an observational study of brain infection conducted on the neuro-infection ward of the Hospital for Tropical Diseases (HTD), Ho Chi Minh City, Vietnam. The HTD is a 550-bed centre providing secondary and tertiary treatment for a wide range of tropical infections from southern Vietnam [@thwaites2002]. The observational study received ethical approvals from HTD and the Oxford Tropical Research Ethics Committee [@donovan2020]. Recruited participants were $\geq 16$ years old, with suspected brain infection of any cause and undergoing lumbar puncture at baseline as a routine diagnostic procedure. Patients were ineligible for enrolment if performing a lumbar puncture was contraindicated, or if written informed consent to join the study was not given (by the patient, or by a relative if the patient lacked capacity to consent).

Participants enrolled between 29th August 2017 and 22nd January 2021 were included. Participants were excluded from this analysis if no uncontaminated CSF mycobacterial culture was available performed within one week from enrolment.

## Data collection

### Clinical and imaging data

Demographic data (age, gender) and relevant medical history were collected. HIV status was recorded when testing was performed; this testing was directed by treating clinicians as guided by acquisition risks and presenting disease. For cases of TBM, baseline modified Medical Research Council (MRC) TBM severity grade [@wilkinson2017] was assessed. Study participants underwent a baseline chest X-ray. Brain imaging was performed if clinically indicated but not recorded in the dataset. 

### Cerebrospinal fluid analysis

Lumbar CSF sampling was performed at enrolment time for routine parameters; white blood cells and cellular differential, protein, glucose (with paired blood glucose taken at the same time), and lactate. A Gram stain was performed to investigate for bacterial meningitides, and an India-ink stain, together with cryptococcal antigen lateral flow tests were performed to investigate for cryptococcal meningitis, if suspected. Where possible at least 6mL CSF was used for mycobacterial testing by ZN-Smear, Xpert or Xpert MTB/RIF Ultra (Xpert Ultra), and MGIT. Xpert and Xpert Ultra were considered diagnostically comparable [@donovan2020] and were combined as Xpert in this study. If CSF was repeatedly sampled (as directed by clinical need), only the first sample with at least 3mL of CSF collected and not later than 7 days since enrolment was used. Methods of CSF processing have previously been described [@donovan2020]. Briefly, CSF samples were centrifuged at 3000g for 15 minutes, and most of the CSF supernatant was removed. The CSF deposit was re-suspended in 500µL of remaining supernatant, with this resuspended pellet then used for ZN smear (100µL), MGIT (200µL), and Xpert (200 µL).

### Diagnosis and treatment

At baseline and during follow-up, TBM diagnosis was assigned for each participant corresponding to the uniform case definition [@marais2010]. All participants with confirmed or suspected TBM received anti-TB chemotherapy regimens according to national and local treatment guidelines. At the time of discharge or death, they received a final diagnosis. If at least one of ZN-Smear, Xpert, or MGIT from CSF was positive at any time during the follow-up, the patient was considered to have confirmed TBM. The participant was classified as suspected TBM if confirmatory microbiological and molecular tests were negative, but TBM was clinically suggested and treated. Those who recovered without anti-TB chemotherapy, or had an alternative diagnosis confirmed microbiologically, were assigned another diagnosis (i.e., not TBM).

## Statistical analysis {#stats-analysis}

We used a two-step approach in our study. In the first step, we used LCA to estimate TBM prevalence and the performance of three confirmatory tests (ZN-Smear, MGIT, and Xpert) in our study population (indicator model). We defined *non-TBM* and *TBM* as the two latent classes. The prevalence were then used to fit a logistic regression model to quantify individual risks based on non-specific features (prevalence model). This risk is supposed to be interpreted as the probability of TBM before any confirmatory tests were taken. As the three tests share similar mechanisms of detecting the existence of *Mtb* in the collected samples, we added an individual random effect -- which we called the mycobaccillary burden -- to correct for there collinearity [@qu1996; @schumacher2016]. The latent mycobacillary burden was regressed on a set of aggravating factors (bacillary burden model) (Figure \@ref(fig:skeleton-model)). 

The inclusion of relevant risk factors and aggravating factors was based on prior knowledge [@marais2010] of the association of them with TBM status and bacterial burden (Supplementary Table \@ref(tab:predictor-tab)). We added three indicators of an alternative diagnosis to TBM: (1) CSF eosinophil count - a strong biomarker for eosinophilic meningitis, a relatively common condition in Vietnam, usually caused by *Angiostrongylus cantonensis*; (2) positive CSF Indian Ink or cryptococcal meningitis lateral flow tests; and (3) CSF Gram stain for non-acid-fast bacterial meningitis. Also added was CSF red cell count whose high numbers being a marker of a traumatic lumbar puncture requiring corrections to white cell counts and biochemical features [@greenberg2008; @nigrovic2011; @mehl1986]. A complete formulation of our model design was reported in the supplementary documents.

In the second step, we *(i)* used the individual risks estimated in step 1 to fit a simplified prevalence model that excluded laboratory information, allowed us to create a simple screening score table; and *(ii)* calculated an updated probability to have TBM after retrieving results of some or all confirmatory assays, relative to the pre-test TBM probability. Because any positive test means definite TBM and MGIT is usually the most delayed test, we limited to five scenarios where different sets of confirmatory test were available and negative at diagnosis: _(a)_ only Smear, _(b)_ only Xpert, _(c)_ Smear and MGIT, _(d)_ Smear and Xpert, and _(e)_ all three tests.

Missing values were handled based on their expected missingness mechanism (Supplementary Table \@ref(tab:missing-handling)). We later tested their validity by conducting appropriate sensitivity analyses (Statistical supplementary document). We chose a Bayesian approach and incorporated prior knowledge [@thwaites2004; @nhu2013; @heemskerk2018] on test sensitivity and specificity; weakly informative prior distributions were used for all model coefficients (Supplementary Figure \@ref(fig:mv-priors)). Posterior estimations were obtained via Hamiltonian Markov Chain Monte Carlo using *R* version 4.2 [@rcoreteam] and *Stan* 2.27 [@stan-doc]. Convergence was evaluated by the Brooks-Gelman-Rubin $\hat{R}$ statistic. All results are presented as median and quantile-based 95% credible intervals (CrI), unless specified otherwise. 

We compared different models and selected the best one using the expected log point-wise predictive density (elpd) [@vehtari2016]. Receiver operating characteristic (ROC) curves and area under the ROC curve (AUC) for all three confirmatory tests were reported. We also used the hospital discharge diagnosis as a pseudo-gold standard to validate our prevalence model. The optimal cut point for TBM classification was chosen using Youden’s Index. All performances metrics were calculated from repeated cross validation procedure. Model code were published on project's github repository [@tbmrepo].


<!--Since latent class analysis models unobserved characteristics, results may be strongly dependent on our assumptions. Therefore, we conducted sensitivity analyses where some assumptions were lifted or changed. We first increased the standard deviation of our prior for specificities of all confirmatory tests so that every value in the range of 90%-100% were accepted. We also changed the prior distributions of the parameters in the prevalence and bacillary burden models from *normal* to a more skeptical one *Student's t* with 4 degrees of freedom; means and scales, however, were kept as-is. Their *elpd*s were compared. Thirdly, as recent studies suggested a sup-optimal specificity of Xpert test on CSF samples [@nhu2013; @chen2020], we considered a Missing-At-Random scenario, where observation chance of confirmation tests depend on the unknown TBM status and locally independent to the value of confirmation tests. Observation status was then included in the model as a separated manifest variables. We visualised the estimates of this model with the best performing one in our main analysis.

Furthermore, to explore hidden effects, we added quadratic terms for all five CSF bio-markers and RGCS to the prevalence model; CSF volume was additionally included to capture its potential impact on test sensitivity. *Laplace* priors were utilised instead of *Normal* for all linear covariates. Posteriors and performance metrics of this model were reported.-->

<!-- All data preparation, cleaning, and processing were performed on statistical package R, version 4.1.1 [@rcoreteam]. Posterior distributions were obtained via Hamiltonian Markov Chain Monte Carlo with 8000 effective iterations in each of 4 chains, using RStan [@stan-doc] package, version 2.27 [@stan]. <!--. Plotting was done using package bayesplot [@bayesplot], classifierplots [@classifierplots], and ggvenn [@ggvenn]. Post-hoc linear mixed-effect model was fitted by package lme4 [@lme4]. -->

