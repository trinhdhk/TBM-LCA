# Methods

## Participants

We used data from a prospective observational study on individuals with suspected brain infection who were admitted to the neuro-infection ward of the Hospital for Tropical Diseases (HTD), Ho Chi Minh City, Vietnam [@donovan2020]. The HTD is a 550-bed centre providing secondary and tertiary treatment for a wide range of tropical infections in Southern Vietnam [@thwaites2002]. The study received ethical approval from HTD and the Oxford Tropical Research Ethics Committee and written informed consent was obtained from all participants or their relatives if they were incapacitated [@donovan2020]. 

Participants were $\geq 16$ years old and were enrolled between 29^th^ August 2017 and 22^nd^ January 2021. All were suspected of neurological infection and underwent lumbar puncture at baseline as a routine diagnostic procedure. Patients were ineligible for enrolment if performing a lumbar puncture was contraindicated and excluded from our analysis if the mycobacterial cultures of CSF taken within the first week were contaminated.

## Data collection

### Clinical and imaging data

Demographics (age, gender) and relevant medical history were collected. HIV tests were only conducted on those with identified risk factors for HIV infection. All participants underwent a chest X-ray. Brain imaging was not performed routinely and not included in the database.

### Cerebrospinal fluid (CSF) analysis

White cell count (WCC) and cellular differential, protein, glucose (with paired blood glucose taken at the same time), and lactate were measured at enrolment. A Gram stain was performed to screen for bacterial meningitis, PCR/serology for viral meningitis, PCR for Angiostrongylus cantonensis, and India-ink staining and a cryptococcal antigen lateral flow test if cryptococcal meningitis was suspected. Where possible at least 6mL CSF was used for mycobacterial testing by ZN-Smear, MGIT, and either Xpert MTB/RIF or Xpert MTB/RIF Ultra (Xpert Ultra). We combined Xpert Ultra with Xpert as they were diagnostically comparable for TBM in our setting [@donovan2020]. In case an insufficient sample of CSF was collected, the microbiological tests were done according to case-by-case clinical judgement. In brief, if there was no clinical suggestion of TBM, the priority might be shifted to finding other diagnoses. If CSF was repeatedly sampled (as directed by clinical need), only the first sample was used as long as it had at least 3mL of CSF and was not collected later than 7 days since enrolment. Methods of CSF processing have been described elsewhere [@donovan2020].

### Diagnosis and treatment

All patients received treatment according to the national and local guidelines. At the time of discharge or death, all were given a final diagnosis, based on the available clinical and laboratory information, including treatment response. If at least one of ZN-Smear, Xpert, or MGIT from CSF was positive at any time, the patient had _definite TBM_. Patients had _suspected TBM_ if confirmatory microbiological and molecular tests were negative, but TBM was clinically suggested and anti-TB drugs were started. Those who recovered without anti-TB chemotherapy or had an alternative diagnosis confirmed microbiologically (e.g., by culture, PCR, or antigen tests), were assigned another diagnosis (i.e., _not TBM_).

## Statistical analysis {#stats-analysis}

Our latent class model for TBM has two components, both consist of logistic regression models (Figure \@ref(fig:skeleton-model)). In the *indicator model* we made the results of three observed confirmatory tests ZN-Smear, MGIT, and Xpert depend on TBM status. The *prevalence model* quantifies the probability to have TBM. This probability is purely based on the diagnostic features, prior to any confirmatory tests. As the three tests share similar mechanisms of detecting the presence of *Mtb*, we added an individual random effect -- which we call the mycobacillary burden -- to eliminate their collinearity [@qu1996; @schumacher2016]. The latent mycobacillary burden was related to a set of modulating factors (*bacillary burden sub-model*). 

The choice of diagnostic features and modulating factors was based on prior knowledge of their association with TBM status and bacterial burden [@marais2010] (Clinical supplementary appendix). We added three indicators of an alternative diagnosis to the prevalence model: (1) positive CSF eosinophil count - a strong biomarker for eosinophilic meningitis, a relatively common condition in Vietnam, usually caused by *Angiostrongylus cantonensis*; (2) positive CSF Indian-ink staining or cryptococcal antigen lateral flow test; and (3) positive CSF Gram stain for non-acid-fast bacterial meningitis. We also included CSF red cell count as it is a marker of a traumatic lumbar puncture, which requires corrections to WCC and biochemical features [@greenberg2008; @nigrovic2011; @mehl1986]. A complete formulation of our model design is reported in the Statistical supplementary appendix.

We used the individual estimated TBM risk from the above model to fit a *simplified prevalence model* that excluded laboratory information. In their stead, we added some simple clinical symptoms involved in a TBM diagnosis: fever, headache, neck stiffness, and psychosis. These variables were easy to measure and less prone to missingness. This allowed us to create a simple risk score table for quick screening. Furthermore, we used Bayes’ rule to calculate the change in probability to have TBM after retrieving results of some or all confirmatory tests, relative to the pre-test TBM probability (Clinical supplementary document). Because any positive test means definite TBM, and because MGIT culture results take 2-8 weeks, we limited to five scenarios where negative confirmatory test results become available: _(a)_ only Smear, _(b)_ only Xpert, _(c)_ Smear and MGIT, _(d)_ Smear and Xpert, and _(e)_ all three tests.

Missing values were handled based on their expected missingness mechanism (Clinical supplementary appendix). We later tested their validity by conducting appropriate sensitivity analyses in the Statistical supplementary appendix.

We chose a Bayesian approach for estimation and incorporated prior knowledge [@thwaites2004; @nhu2013; @heemskerk2018] on test sensitivity and specificity. on test sensitivity and specificity. Weakly informative prior distributions were used for all model coefficients (Statistical supplementary appendix). Estimates of the posterior distributions were obtained via Hamiltonian Markov Chain Monte Carlo using R version 4.2 [@rcoreteam] and Stan 2.27 [@stan-doc]. Convergence was evaluated by the Brooks-Gelman-Rubin $\hat{R}$ statistic. All results are presented as medians and equal-tailed 95% credible intervals (CrI), unless specified otherwise. 

We compared different models and selected the best one using the expected log point-wise predictive density (elpd) [@vehtari2016]. To give an informal insight, we compared our full and simplified prevalence model with the final hospital diagnosis as a pseudo gold standard - in which a patient is considered as having TBM if they were diagnosed with suspected or definite TBM. A proper validation of the selected model was performed on the observed confirmatory test results and is explained in the Statistical supplementary document. All performance metrics were calculated using repeated cross-validation procedures. Model code is available on the project’s GitHub repository [@tbmrepo].