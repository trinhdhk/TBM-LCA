# Results

```{r calc_na}
suspected_hiv <- data_dirty |> filter(DISDIA %in% c('DIA1', 'DIA10', 'DIA12'))
n_test_suspected_hiv <- nrow(suspected_hiv) - na(suspected_hiv$hiv_stat)
```

## Clinical characteristics

A total of `r nrow(data_dirty)` patients with suspected brain infection enrolled into the study. Of these,  `r nrow(data_19EI)` were included in the analysis. Reasons for exclusion are shown in Figure \@ref(fig:patient-flow). Characteristics of included individuals are summarised in table \@ref(tab:test-bl-tbl), overall and sratified by confirmatory test results. The median age of included individuals was `r quantile(data_19EI$age, .5, na.rm=TRUE) |> round(1)`, with little variation. HIV co-infection status was recorded for `r nrow(data_19EI) - na(data_19EI$hiv_stat)`/`r nrow(data_19EI)` (`r round((nrow(data_19EI) - na(data_19EI$hiv_stat))/nrow(data_19EI)*100, 0)`%) enrolled individuals. Both HIV prevalence and duration from symptom onset to hospitalisation in any test positive group was consistently higher than those in the other. Overall, there were `r var[5]` participants with valid TBM confirmatory tests, `r var[7]` were microbiologically confirmed (Figure \@ref(fig:venn-test)), while `r var[11]` were later confirmed with another disease. In the group not tested for TBM, `r var[9]` patients were microbiologically diagnosed with another pathogen than *Mtb*. For `r var[8]+var[10]` patients no confirmed diagnosis could be made, but they were unlikely to have TBM.

## Model estimates

```{r est_fun, include=FALSE}
est = \(name, tab, digits=2, transformation = I, ci.sep = ', ', post.fn = I, pre.fn=I) {
  m <- c(pre.fn(tab[name, c('mean', '50%')]), pre.fn(tab[name, '2.5%']), pre.fn(tab[name, '97.5%'])) |>
    unlist() |> 
    transformation() 
  list(mean = m[1]|> formatC(digits=digits, format='f') |> post.fn(), 
    median = m[2]|> formatC(digits=digits, format='f') |> post.fn(),
    ci = paste(min(m[3:4]) |> formatC(digits=digits, format='f') |> post.fn(), 
          max(m[3:4]) |> formatC(digits=digits, format='f') |> post.fn(), sep=ci.sep))
}

spc.est = purrr::partial(est,
                         transformation=\(x) 100*(1-x), ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))
sen.est = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))

spc.est2 = purrr::partial(est,
                         transformation=\(x)  100*(1-x), ci.sep=' - ', digits=1)
sen.est2 = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1)

sen = \(name, hiv=NULL, fn=sen.est, sep = ' ', str = '{median} ({ci})') {
  name = paste0(name, '[2]')
  out = glue::glue_data(fn(name, 
                           tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary),
                        str)
  # out = do.call(sprintf, as.list(c('%s; %s (%s)', fn(name, 
                                                # tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
  gsub('\\s\\(', paste0(sep, '('), out)
}

spc = \(name, hiv=NULL, fn=spc.est, sep = ' ', str = '{median} ({ci})' ) {
  name = paste0(name, '[1]')
  out = glue::glue_data(fn(name, 
                           tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary),
                        str)
  # out = do.call(sprintf, as.list(c('%s; %s (%s)', fn(name,
                                                # tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
  gsub('\\s\\(', paste0(sep, '('), out)
}
```

Posterior estimates of sensitivity and specificity of ZN-Smear, MGIT, and Xpert are reported in Table \@ref(tab:mv-posterior). All three had over 99% specificity. Smear was the most sensitive test with `r sen('z_Smear', hiv=FALSE, str = 'median = {median} (95% CrI = {ci})')` for HIV negative patients and `r sen('z_Smear', hiv=TRUE, str = '{median} ({ci})')` for HIV positive patients. Xpert was the least sensitive, especially in HIV negative patients, with only `r sen('z_Xpert', hiv=FALSE, str = '{median} ({ci})')`, but its sensitivity was much higher and comparable to that of ZN-Smear in the HIV positive group: `r sen('z_Xpert', hiv=TRUE, str = '{median} ({ci})')`.

Estimated coefficients for TB risk factors in the prevalence model are shown in Figure \@ref(fig:coef-est). Patients with HIV, miliary TB, and long symptom duration were in the higher risk group of TBM. Of the laboratory variables, increased TBM risk was associated with low CSF glucose, low paired blood glucose, high CSF protein, and high lactate, albeit not significant. Patients with approximately 200 WBC/mm^3^ in CSF were estimatedly at the highest risk. Amongst the factors that impact bacillary burden, HIV and higher CSF protein were both associated with higher burden, while glucose and WBC associated with lower burden. Although higher lymphocyte count in CSF relates to TBM, it was associated with a reduction in the expected mycobacterial burden, which reduced sensitivity.

## Model validation 

Our selected model showed good discrimination with cross-validated AUCs of `r (pROC::auc(response = data_19EI$csf_smear, predictor = m3$p$p_Smear$mean)*100) |> round(0)`% for ZN Smear, `r (pROC::auc(response = data_19EI$csf_mgit, predictor = m3$p$p_Mgit$mean)*100) |> round(0)`% for MGIT, and  `r (pROC::auc(response = data_19EI$csf_xpert, predictor = m3$p$p_Xpert$mean)*100) |> round(0)`% for Xpert (Figure \@ref(fig:model-metrics)). The model was also well calibrated: estimated probabilities and smoothed frequency of positive tests showed overall agreement [@VanCalster2019], with a slight drop at the upper tail of for MGIT culturing and Xpert. When comparing TBM risk prediction against hospital diagnosis, the AUC was  `r (pROC::auc(response = !data_19EI$other_dis_dx, predictor = m3$p$theta$mean)*100) |> round(0)`% and the calibration plot shows a good correspondence tiny over-estimation at the middle of the curve with intercept = 0.025 and slope = 0.98. 

## Updated estimated TBM risk if some or all confirmatory tests are negative

```{r load-fit, include=FALSE}
post_test = list()
post_test$dat <- readRDS(file.path(data_dir, '..', 'export', 'post_test_fraction.RDS'))
post_test$get_sample <- function(name, hiv=FALSE){
  n = switch(name, 
             smear = 'a', xpert = 'b', smear_mgit = 'c', smear_xpert = 'd', all = 'e')
  with(post_test, {
    hiv.pop = dat$hiv == hiv
    target.pop = dat[[n]]
    # if (inv) target.pop = 1/(target.pop)
    target.pop[!hiv.pop] = NA
    target.pop
    apply(target.pop,1,mean,na.rm=T)
  })
}

post_test$get_est <- function(name, hiv=FALSE, inv=FALSE, str = ' {median} ({ci[[1]]} - {ci[[2]]})'){
  est = post_test$get_sample(name, hiv)
  f = if (inv) {\(x) 1/x} else I
  
  mean = mean(est, na.rm=TRUE) |> f() |> formatC(digits=2, format='f')
  median = median(est, na.rm=TRUE) |> f() |> formatC(digits=2, format='f')
  ci = quantile(est, c(.025, .975), na.rm=TRUE) |> f() |> sort() |> formatC(digits=2, format='f')
  glue::glue(str)
}

post_test_tbl = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-', '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-', '-'),
    HIV_neg = c(post_test$get_est("smear"),
                post_test$get_est("xpert"), 
                post_test$get_est("smear_mgit"), 
                post_test$get_est("smear_xpert"),
                # post_test$get_est("mgit_xpert"),
                post_test$get_est("all")
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE),
                post_test$get_est("xpert", hiv=TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE),
                post_test$get_est("all", hiv=TRUE))
  )

post_test_tbl_inv = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-',  '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-','-'),
    HIV_neg = c(post_test$get_est("smear", inv = TRUE),
                post_test$get_est("xpert", inv = TRUE), 
                post_test$get_est("smear_mgit", inv = TRUE), 
                post_test$get_est("smear_xpert", inv = TRUE),
                # post_test$get_est("mgit_xpert", inv = TRUE),
                post_test$get_est("all", inv = TRUE)
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE, inv = TRUE),
                post_test$get_est("xpert", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE, inv = TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE, inv = TRUE),
                post_test$get_est("all", hiv=TRUE, inv = TRUE))
  )
```
 
<!--Figure \@ref(fig:fit-post-test-change) demonstrates TBM probability in our population given a chronological scenario where ZN Smear, Xpert, and MGIT culture results sequentially returned negative over time. --> The changes in probability to have TBM relative to the pre-test values are shown in Table \@ref(tab:tbl-post-test) for 5 scenarios. A negative ZN-Smear only was associated with a median of `r post_test$get_est("smear", inv = TRUE, str = '{median}')`-fold reduction in TBM risk for HIV-uninfected patients and a `r post_test$get_est("smear", hiv=TRUE, inv = TRUE, str='{median}')`-fold reduction for HIV-infected patients. Having both a negative Smear and MGIT was associated with a `r round(1/.41,2)` times lower probability of TBM. With all tests negative, the TBM probability reduced by `r post_test$get_est("all", inv = TRUE, str = '{median}')` and `r post_test$get_est("all", hiv=TRUE, inv = TRUE, str = '{median}')` for HIV negative and positive respectively. 

## Simplified model

In the simplified model, HIV infection, longer symptom duration at hospitalisation, and TB evidences found on clinical examination or chest X-Ray were significantly associated with a TBM diagnosis (Figure \@ref(fig:simplified-model-plot)). Focal neurological deficit and cranial nerve palsy, without the existence of laboratorial tests, both showed as weak risk factors in this multivariate context. Headache was shown as a risk factor for TBM, as opposed to psychosis. Our simplified model had good AUC against binary class generated from our prevalence model. The best cut-point maximising Youden's index of 23.4% had sensitivity of 86.0% and specificity of 68.0%. We built a screening score table by selecting rounded values within the 50% credible intervals of every coefficient (Table \@ref(tab:score-table)). Continuous features were cut into bins so that each bin accounts for 0.5 points increase in the total calculation.