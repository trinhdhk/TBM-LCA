# Results

```{r calc_na}
suspected_hiv <- data_dirty |> filter(DISDIA %in% c('DIA1', 'DIA10', 'DIA12'))
n_test_suspected_hiv <- nrow(suspected_hiv) - na(suspected_hiv$hiv_stat)
```

## Clinical characteristics

<!--From 29th August 2017 to 22nd January 2021--> Out of `r nrow(data_dirty)` patients with suspected brain infection enrolled into study. `r nrow(data_19EI)` were included in the analysis (Figure \@ref(fig:patient-flow)). Characteristics of included individuals are summarised in table \@ref(tab:test-bl-tbl), stratified by confirmatory test results. Mean age was around `r quantile(data_dirty$age, .5, na.rm=TRUE) |> round(1)`, and was similar in each subgroup. HIV infection were tested for `r nrow(data_dirty) - na(data_dirty$hiv_stat)` (`r round((nrow(data_dirty) - na(data_dirty$hiv_stat))/nrow(data_dirty)*100, 0)`%) enrolled individuals. Both HIV prevalence and duration from symptom onset to hospitalisation in the test positive groups were consistently higher than those in the test negative groups. Overall, there were `r var[5]` participants with valid TBM confirmatory tests, `r var[7]` were microbiologically confirmed (Figure \@ref(fig:venn-test)), while `r var[11]` were later confirmed with another disease. In the group not tested for TBM, `r var[9]` patients were microbiologically diagnosed with another pathogen than *Mtb*. For `r var[8]+var[10]` patients no confirmed diagnosis could be made, but they were unlikely to have TBM.

```{r echo=FALSE}
pop = data_dirty[,(wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    !(csf_mgit_contaminated %in% T) ]
var = c()
var[1] <- nrow(data_dirty)
var[2] <- sum(is.na(data_dirty$wrong_name) | data_dirty$wrong_name, na.rm=TRUE)
var[3] <- data_dirty[, sum(
  (wrong_name%in%F) & 
    ((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)))]
var[4] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    (is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[5] <- with(data_dirty,sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    !(is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[6] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    csf_mgit_contaminated, na.rm=TRUE))
var[7] <- with(data_dirty,  sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    !(csf_mgit_contaminated %in% T) &
    (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
    ((csf_smear%in%T)|(csf_mgit%in%T)|(csf_xpert%in%T)), na.rm=TRUE))
var[8] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      !(other_dis_dx_conf%in%T)&
      !((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
var[9] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE))  &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)&
      (other_dis_dx_conf%in%T),
    na.rm=TRUE))
var[10] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) & 
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert) &
      !(other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[11] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      (other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[12] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      # !(other_dis_dx_conf%in%T)&
      ((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
```

```{diagrammer patient-flow, fig.show="hold", out.width="100%", out.height="10cm",  fig.align="center", fig.cap="Recruited patient profile", fig.id="patient-flow"}
#check final number
digraph patientflow {
  # compound = true;
  graph[fontname="CMU Serif", splines=line];
  node[fontname = "CMU Serif", shape="rectangle"];
  # edge[splines=line]
  
  Total [label = "@@1 enrolled and have CSF samples collected" ]
  n1[shape="circle",width=0,height=0, label=""];
  n2[shape="circle",width=0,height=0, label=""];
  n3[shape="circle",width=0,height=0, label=""];
  n4[shape="circle",width=0,height=0, label=""];
  n5[shape="circle",width=0,height=0, label=""];
//   n6[shape="circle",width=0,height=0, label=""];

  subgraph exclude1{
    WrongName [label ="@@2 excluded due to mis-matched names"]
    LowVolume [label = "@@3 excluded due to low CSF volume collected within 7 days"]
    Tested [label = "@@5 tested for TBM"]
  }
  

    Contaminated [label = "@@6 excluded due to contaminated culture"]
  {rank=same; n1; WrongName}
  {rank=same; n2; LowVolume}
  {rank=same; n4; Contaminated}
  {rank=same; n3; n5}
  NotTested [label = "@@4 not tested for TBM"]
  # {rank=same; WrongName; LowVolume}
  {rank=same; Tested; NotTested}
  
  TBM [label = "@@7 confirmed TBM\l\n@@12 suspected TBM\l\n@@11 confirmed other cause\l\n@@8 unconfirmed cause\l"]
  NotTBM [label = "@@9 confirmed other disease\l\n@@10 unconfirmed cause\l"]
  {rank=same; TBM; NotTBM};
  
  Total:s -> n1:n[dir=none];
  WrongName -> n1[dir=back];
  n1:s -> n2:n[dir=none];
  LowVolume -> n2[dir=back];
  n2:s -> n3:n[dir=none];
  n3 -> n5[dir=none];
  n5:s -> NotTested:n
  n5:w -> NotTested:e[style=invis];
  n3:s -> Tested:n
  NotTested:s -> NotTBM:n
  NotTested:s -> NotTBM:n
  Tested:s -> n4:n[dir=none]; 
  Contaminated -> n4[dir=back];
  n3:w -> Contaminated:n[style=invis];
  n4:s -> TBM:w[style=invis];
  n4:s -> TBM:n;
}
[1]: var[1]
[2]: var[2]
[3]: var[3]
[4]: var[4]
[5]: var[5]
[6]: var[6]
[7]: var[7]
[8]: var[8]
[9]: var[9]
[10]: var[10]
[11]: var[11]
[12]: var[12]
```

```{r venn-test, out.width='50%', fig.align='center', fig.asp=1, fig.width=6, fig.cap = 'Venn diagram for ZN Smear, MGIT, and Xpert'}

data_19EI |>
  mutate(across(c(csf_smear, csf_mgit, csf_xpert), as.logical)) |>
  ggplot() +
  ggvenn::geom_venn(aes(A = csf_smear, B = csf_mgit, C = csf_xpert), 
                    fill_color = c('#E5707E', '#E6B566', '#A3DDCB'),
                    stroke_color = c('#E5707E', '#E6B566', '#A3DDCB'),
                    set_names = c('ZN Smear', 'MGIT', 'Xpert'),
                    text_size = 3, set_name_size = 4) +
  theme_void()

```

\newpage

\blandscape

<!---BLOCK_LANDSCAPE_START--->

```{r test-bl-tbl, echo=FALSE, tab.cap="Baseline characteristics of all study patients", tab.id="test-bl-tbl"}
bl_tbl <- 
  data_dirty |>
  filter(pop) |>
  as_tibble() |>
  # dplyr::filter(!(wrong_name %in% TRUE) & !(csf_mgit_contaminated %in% TRUE))
  mutate(csf_neutro = csf_wbc - csf_lympho - csf_eos) |>
  mutate(
    across(c(csf_smear, csf_xpert, csf_mgit), 
           ~ factor(.x, 
                    levels = c(TRUE, FALSE,NA), 
                    labels = c('Positive', 'Negative', 'Missing'),
                    exclude = NULL
           )
    )
  ) |>
  select(age, hiv_stat, clin_illness_day, clin_symptoms, clin_contact_tb, clin_motor_palsy, clin_nerve_palsy, clin_gcs, xray_pul_tb, xray_miliary_tb, csf_lympho, csf_wbc, csf_eos, csf_rbc, csf_protein, csf_lactate, csf_glucose, bld_glucose = BLDGLU, csf_crypto, csf_gram, csf_smear, csf_xpert, csf_mgit) |>
  tidyr::pivot_longer(
    c(csf_smear, csf_mgit, csf_xpert),
    names_to = 'Test',
    values_to = 'Result'
  ) |>
  my_fn$add_labels(
    age               = 'Age (year)',
    hiv_stat          = 'HIV positive', 
    clin_illness_day  = 'Symptom duration (day)',
    clin_symptoms     = 'TB-suggested systemic symptoms',
    clin_contact_tb   = 'Noticeable TB contact within the last 12 months',
    clin_motor_palsy  = 'Focal neurological deficit',
    clin_nerve_palsy  = 'Cranial nerve palsy',
    # GCSV              = 'Glasgow Coma Scale-Verbal',
    # GCSM              = 'Glasgow Coma Scale-Motor',
    # GCSE              = 'Glasgow Coma Scale-Eyes',
    clin_gcs          = 'Glasgow Coma Score',
    xray_pul_tb       = 'X-Ray Pulmonary TB (excluding Miliary TB)',
    xray_miliary_tb   = 'X-Ray Miliary TB',
    csf_lympho        = 'CSF Lymphocyte Count (cell/mm^3^)',
    csf_wbc           = 'CSF WBC Count (cell/mm^3^)',
    # csf_neutro        = 'CSF Neutrophil Count',
    csf_eos           = 'CSF Eosinophil Count (cell/mm^3^)',
    csf_rbc           = 'CSF Red blood cell Count (cell/mm^3^)',
    csf_protein       = 'CSF Protein (g/l)',
    csf_lactate       = 'CSF Lactate (mmol/l)',
    csf_glucose       = 'CSF Glucose (mmol/l)',
    bld_glucose       = 'Paired Blood Glucose (mmol/l)',
    csf_crypto        = 'Cryptococcal Antigen/Indian Ink +',
    csf_gram          = 'Gram stained'
  ) |>
  # mutate(- csf_neutro) |>
  mutate(
    Test = case_when(
      Test == 'csf_smear' ~ 'Smear',
      Test == 'csf_mgit'  ~ 'MGIT',
      Test == 'csf_xpert' ~ 'Xpert',
    )
    # Result = ifelse(is.na(Result), 'Missing', Result) |> factor()
  ) |>
  tbl_strata(
    strata = Test,
    .tbl_fun = ~ tbl_summary(
      .x, 
      by = Result,
      missing_text = '  - Missing',
      # type = list(GCSV~'continuous', GCSE~'continuous',GCSM~'continuous'),
      statistic = list(
        all_continuous() ~ '{mean} ({p25}, {p75})'),
      digits = list(csf_eos ~ c(0, 0, 0), clin_gcs ~ c(0, 0, 0))
    ) |> add_n()
  ) |>
  modify_footnote(
    update = all_stat_cols() ~ "Mean (1st, 3rd quartiles) for numeric variables; n (%) for categorical variables",
    text_interpret = "html"
  )

bl_tbl |> as_flex_table() |>
  # flextable::set_caption('Baseline characteristics') |>
  flextable::width(width = .79) |>
  flextable::width(j = 1, width = .89) |>
  flextable::width(j = c(2,6,10), width = .23) |>
  flextable::fontsize(size=9, part = 'all') |>
  ftExtra::colformat_md(1, part='body') |>
  flextable::theme_vanilla()
```

<!---BLOCK_LANDSCAPE_STOP--->

\elandscape

\newpage

## Model estimates

```{r est_fun, include=FALSE}
est = \(name, tab, digits=2, transformation = I, ci.sep = ', ', post.fn = I, pre.fn=I) {
  m <- c(pre.fn(tab[name, 'mean']), pre.fn(tab[name, '2.5%']), pre.fn(tab[name, '97.5%'])) |> transformation() 
  c(m[1]|> formatC(digits=digits, format='f') |> post.fn(),
    # m[2]|> formatC(digits=digits, format='f') |> post.fn(), 
    paste(min(m[2:3]) |> formatC(digits=digits, format='f') |> post.fn(), 
          max(m[2:3]) |> formatC(digits=digits, format='f') |> post.fn(), sep=ci.sep))
}

spc.est = purrr::partial(est,
                         transformation=\(x) 100*(1-x), ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))
sen.est = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))

spc.est2 = purrr::partial(est,
                         transformation=\(x)  100*(1-x), ci.sep=' - ', digits=1)
sen.est2 = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1)

sen = \(name, hiv=NULL, fn=sen.est, sep = ' ') {
  name = paste0(name, '[2]')
  out = do.call(sprintf, as.list(c('%s (%s)', fn(name, 
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
  gsub('\\s\\(', paste0(sep, '('), out)
}

spc = \(name, hiv=NULL, fn=spc.est, sep = ' ') {
  name = paste0(name, '[1]')
  out = do.call(sprintf, as.list(c('%s (%s)', fn(name,
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
  gsub('\\s\\(', paste0(sep, '('), out)
}
```

Posterior estimates of sensitivity and specificity of Smear, MGIT, and Xpert are reported in Table \@ref(tab:mv-posterior). All three had over 99% specificity. Smear was the most sensitive test with `r sen('z_Smear', hiv=FALSE)` for HIV negative patients and `r sen('z_Smear', hiv=TRUE)` for HIV positive patients. Xpert was the least sensitive, especially in HIV negative patients, with only `r sen('z_Xpert', hiv=FALSE)`, but its sensitivity was much higher and comparable to that of MGIT in the HIV positive group: `r sen('z_Xpert', hiv=TRUE)`.

Estimated coefficients for TB risk factors in the prevalence model are shown in Figure \@ref(fig:coef-est). Patients with HIV, miliary TB, and long symptom duration were in the higher risk group of TBM. Of the laboratory variables, increased TBM risk was associated with low CSF glucose, low paired blood glucose, high CSF protein, and high lactate, albeit not significant. Patients with approximately 200 WBC/mm^3^ in CSF were estimatedly at the highest risk. Amongst the factors that impact bacillary burden, HIV and higher CSF protein were both associated with higher burden, while glucose and WBC associated with lower burden. Although higher lymphocyte count in CSF relates to TBM, it was associated with a reduction in the expected mycobacterial burden, which reduced sensitivity.

```{r mv-posterior, tab.cap="Posterior estimates of test sensitivities and specificities, for overall population, and stratified by HIV", tab.id="mv-posterior"}
# Use %
pr_neg <- matrix(c(
  c('Test', rep(c('Specificity (%)'),1), rep(c('Sensitivity (%)'),1)),
  # c('Test', rep(c('Estimates'),2)),
  c('Smear',
    spc("z_Smear", hiv=FALSE, fn=spc.est2, sep='\n'),
    sen("z_Smear", hiv=FALSE, fn=sen.est2, sep='\n')),
  c('MGIT',
    spc("z_Mgit", hiv=FALSE, fn=spc.est2, sep='\n'),
    sen("z_Mgit", hiv=FALSE, fn=sen.est2, sep='\n')),
  c('Xpert',
    spc("z_Xpert", hiv=FALSE, fn=spc.est2, sep='\n'),
    sen("z_Xpert", hiv=FALSE, fn=sen.est2, sep='\n'))
), byrow=T, nrow=4)

pr_pos <- matrix(c(
  c('Test', rep(c('Specificity (%)'),1), rep(c('Sensitivity (%)'),1)),
  c('Smear',
    spc("z_Smear", hiv=TRUE, fn=spc.est2, sep='\n'),
    sen("z_Smear", hiv=TRUE, fn=sen.est2, sep='\n')),
  c('MGIT',
    spc("z_Mgit", hiv=TRUE, fn=spc.est2, sep='\n'),
    sen("z_Mgit", hiv=TRUE, fn=sen.est2, sep='\n')),
  c('Xpert',
    spc("z_Xpert", hiv=TRUE, fn=spc.est2, sep='\n'),
    sen("z_Xpert", hiv=TRUE, fn=sen.est2, sep='\n'))
), byrow=T, nrow=4)

pr <- matrix(c(
  c('Test', rep(c('Specificity (%)'),1), rep(c('Sensitivity (%)'),1)),
  c('Smear',
    spc("z_Smear", hiv=NULL, fn=spc.est2, sep='\n'),
    sen("z_Smear", hiv=NULL, fn=sen.est2, sep='\n')),
  c('MGIT',
    spc("z_Mgit", hiv=NULL, fn=spc.est2, sep='\n'),
    sen("z_Mgit", hiv=NULL, fn=sen.est2, sep='\n')),
  c('Xpert',
    spc("z_Xpert", hiv=NULL, fn=spc.est2, sep='\n'),
    sen("z_Xpert", hiv=NULL, fn=sen.est2, sep='\n'))
), byrow=T, nrow=4)

huxtable::as_hux(cbind(pr, pr_neg[,-1], pr_pos[,-1])) |>
  huxtable::as_flextable() |>
  flextable::add_header_row(values=c("", rep("Overall",2), rep("HIV (-)",2), rep("HIV (+)",2))) |>
  flextable::merge_h(i=1, part='header') |>
  flextable::width(width = .8) |>
  flextable::bold(i=1) |>
  flextable::theme_vanilla() |>
  flextable::align(i=1, align='center') |>
  flextable::align(i=1, align='center', part='header') |>
  flextable::add_footer_row(top=F, values="Values are in the form Mean (95% Credible interval)", colwidths = 7) -> restab
# restab_raster = flextable::as_raster(restab |> flextable::width(width=1.2), zoom=1.2)
restab
```

```{r coef-est, out.width="90%", fig.dim=c(8, 10), fig.align="center", fig.cap="A: Estimates of TBM odd ratios in prevalence model for different covariates, excluding WBC count; B: Estimates of TBM odd ratio for each value of CSF WBC count; C: Estimates of factors impacting individual's bacillary burden, given they have TBM. In A and C: dot, thick lines, and thin lines are posterior expected values, 50\\% and 95\\% credible intervals. In B: the blue line is expected odds ratio, the inner ribbon and outer ribbon are 50\\% and 95\\% credible intervals.", fig.id="coef-est", warning=FALSE, message=FALSE}

library(patchwork)

# rotate xlab 45deg
# log10(eos) > 0 wrong -> eos > 0
# odd ratio
# C: standardised bacillary burden #explain in text
y_labs = m3$a_plot$scales$get_scales('y')$labels
y_labs[3] = "*log<sub>10</sub>* (CSF RBC)"
y_labs[4] = "*log<sub>10</sub>* (CSF Eosinophil)" 
y_labs[5] = 'CSF Eosinophil > 0'
y_labs[6] = "*log<sub>10</sub>* (CSF Lymphocyte)"

y_labs2 = m3$b_plot$scales$get_scales('y')$labels
y_labs2[1] = "*log<sub>10</sub>* (CSF WBC)"  
y_labs2[2] = "*log<sub>10</sub>* (CSF Lymphocyte)"

ab_plot = ((m3$a_plot |> td.misc::change_ylabs(rev(y_labs), top_down = TRUE)) + ggtitle("Prevalence model") + 
             scale_x_continuous(
               name="TBM odd ratio",
               breaks = m3$a_plot$scales$get_scales('x')$breaks,
               labels = m3$a_plot$scales$get_scales('x')$labels) + 
             theme(axis.text.y = ggtext::element_markdown())) / 
  (m3$wbc_plot + theme(axis.title.y=element_text(size=8, face='bold',vjust=-45, color=grey(.3))) +
     scale_y_continuous(
    name = 'TBM odd ratio',
    breaks = log(10^c(-24,-20, -16,-12, -8,-4,-2, -1, 0)),
    labels = c('1e-24','1e-20','1e-16','1e-12','1e-8', '1e-4', 0.01, .1, 1)
  )) /
  ((m3$b_plot |> td.misc::change_ylabs(rev(y_labs2), top_down = TRUE)) + 
     ggtitle("Bacillary burden model") + 
     theme(axis.text.y = ggtext::element_markdown()) + 
     scale_x_continuous(name='Standardised bacillary burden')) /
  # grid::rasterGrob(restab_raster) + 
  patchwork::plot_layout(ncol=1, nrow=3, 
                         heights = c(6,2,2)) + 
  plot_annotation(tag_levels="A")

#ggtitle("CSF WBC count") + theme(title = element_text(face='bold',size=6), title.po

# plt = patchwork::wrap_plots(ab_plot, m3$plot.multggplotGrob(m3$rocs)) + plot_annotation(tag_levels="A")
# plot(plt)
ab_plot
```
```{r coef-est.old, fig.align='center', fig.asp=1.4, fig.cap='Posterior estimates (mean and 50%/95% credible intervals) of coefficients of risk factors for TBM (prevalence model) and variables that impact bacillary burden (latent class model)', message=FALSE, warning=FALSE, out.width='100%', include=FALSE, eval=FALSE}
(a_plot + ggtitle('TBM Risk factor')) /
  (b_plot + scale_x_continuous() + ggtitle('Bacillary burden predictors')) + 
  plot_layout(nrow=2, heights=c(7,2))&
  theme(text = element_text('serif', size = 9), plot.tag = element_text('serif', size = 9), axis.text.y = ggtext::element_markdown(family=NULL, face='bold'), legend.position = "none") 
```

## Model validation 

Our selected model with highest elpd of $-347.0$ ($SE=25.0$) showed good discrimination with cross-validated AUCs of `r classifierplots:::calculate_auc(test.y = data_19EI$csf_smear, pred.prob = m3$p$p_Smear$mean) |> round(0)`% for ZN Smear, `r classifierplots:::calculate_auc(test.y = data_19EI$csf_mgit, pred.prob = m3$p$p_Mgit$mean) |> round(0)`% for MGIT, and  `r classifierplots:::calculate_auc(test.y = data_19EI$csf_xpert, pred.prob = m3$p$p_Xpert$mean) |> round(0)`% for Xpert (Figure \@ref(fig:model-metrics)). The model was also well calibrated, estimated probabilities and smoothed frequency of positive tests showed overall agreement [@VanCalster2019], with a slight drop at the upper tail of for MGIT culturing and Xpert. The AUC of TBM prevalence model against hospital diagnosis was  `r classifierplots:::calculate_auc(test.y = !data_19EI$other_dis_dx, pred.prob = m3$p$theta$mean) |> round(0)`%. The calibration plot shows a good correspondence tiny over-estimation at the middle of the curve with intercept = -0.05 and slope = 0.95. 

```{r model-metrics, fig.align="center", fig.cap='Model performance. A: ROC and AUC against confirmatory test results; B: calibration against confimatory test results; C: ROC and AUC against hospital diagnosis; D: Calibration against hospital diagnosis. For calibration plots, “observed” probabilities are defined as values smoothed by a loess fit against observed binary events, in which the translucent ribbons represent the level of uncertainty of the smoothing. For ROC plots, AUC values are presented as \\emph{“average (min - max over 5 repetitions of cross-validation)”}; the grey lines are fitted curves from each 20-fold cross validation and coloured lines represents their average.' , fig.dim=c(9, 12), fig.show='hold', message=FALSE, warning=FALSE, out.width='80%', fig.id="model-metrics"}

roc_y <- do.call(gridExtra::arrangeGrob, m3$ROC$Y)
m3$calib$Y[[3]] = m3$calib$Y[[3]] + theme(axis.title.y = element_blank())
(wrap_elements(roc_y) / wrap_elements(m3$calib$Y)) /
  (wrap_elements(m3$ROC$C) + wrap_elements(m3$calib$C)) + 
  plot_layout(heights=c(2,2,3)) +
  plot_annotation(tag_levels = 'A')
```

```{r best-metrics.old, include=FALSE, eval=FALSE, fig.align='center', fig.cap='ROC curves (upper half) and calibration plots (lower half) against observed test results for the selected model. Results from each of the 5 CV repetitions are shown in grey and the average curves are in colour.', fig.dim=c(8,6), dpi=600, message=FALSE, warning=FALSE, out.width='90%'}
m3_roc = readRDS(file.path(data_dir, '..', 'export', 'm3_roc.RDS')) 
m3_calib = readRDS(file.path(data_dir, '..', 'export', 'm3_calib.RDS')) 
w = wrap_plots(m3_roc$Y, m3_calib$Y, ncol=1, heights=c(1,1))
plot(w)
```

```{r theta-metrics-prep, include=FALSE, eval=FALSE}
theta_rocs <- m3_roc$C + ggtitle('Hospital Diagnosis') + theme_bw()
theta_calib <- m3_calib$C
```

```{r theta-metrics, fig.align='center', fig.cap='ROC curves and calibration plots for prevalence model againts discharge diagnosis. Results from each of the 5 individual CV repetitions are shown in grey and the average curves are in colour.', fig.dim=c(10,5), dpi=600, message=FALSE, warning=FALSE, out.width='100%', include=FALSE, eval=FALSE}
theta_rocs+theta_calib
```
## Updated estimated TBM risk if some or all confirmatory tests are negative

```{r load-fit, include=FALSE}
post_test = list()
post_test$dat <- readRDS(file.path(data_dir, '..', 'export', 'post_test_fraction.RDS'))
post_test$get_sample <- function(name, hiv=FALSE){
  n = switch(name, 
             smear = 'a', xpert = 'b', smear_mgit = 'c', smear_xpert = 'd', all = 'e')
  with(post_test, {
    hiv.pop = dat$hiv == hiv
    target.pop = dat[[n]]
    # if (inv) target.pop = 1/(target.pop)
    target.pop[!hiv.pop] = NA
    apply(target.pop,1,mean,na.rm=T)
  })
}

post_test$get_est <- function(name, hiv=FALSE, inv=FALSE){
  est = post_test$get_sample(name, hiv)
  f = if (inv) {\(x) 1/x} else I
  
  mean = mean(est) |> f() |> formatC(digits=2, format='f')
  ci = quantile(est, c(.025, .975)) |> f() |> sort() |> formatC(digits=2, format='f')
  glue::glue('{mean} ({ci[[1]]} - {ci[[2]]})')
}

post_test_tbl = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-', '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-', '-'),
    HIV_neg = c(post_test$get_est("smear"),
                post_test$get_est("xpert"), 
                post_test$get_est("smear_mgit"), 
                post_test$get_est("smear_xpert"),
                # post_test$get_est("mgit_xpert"),
                post_test$get_est("all")
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE),
                post_test$get_est("xpert", hiv=TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE),
                post_test$get_est("all", hiv=TRUE))
  )

post_test_tbl_inv = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-',  '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-','-'),
    HIV_neg = c(post_test$get_est("smear", inv = TRUE),
                post_test$get_est("xpert", inv = TRUE), 
                post_test$get_est("smear_mgit", inv = TRUE), 
                post_test$get_est("smear_xpert", inv = TRUE),
                # post_test$get_est("mgit_xpert", inv = TRUE),
                post_test$get_est("all", inv = TRUE)
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE, inv = TRUE),
                post_test$get_est("xpert", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE, inv = TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE, inv = TRUE),
                post_test$get_est("all", hiv=TRUE, inv = TRUE))
  )
```
 
<!--Figure \@ref(fig:fit-post-test-change) demonstrates TBM probability in our population given a chronological scenario where ZN Smear, Xpert, and MGIT culture results sequentially returned negative over time. --> The changes in probability to have TBM relative to the <!--?--> pre-test values are shown in Table \@ref(tab:tbl-post-test) for 5 scenarios mentioned in Section \@ref(stats-analysis). Having a negative Smear only was associated with a `r post_test_tbl_inv$HIV_neg[1]`-fold reduction in TBM risk for HIV-uninfected patients and a `r post_test_tbl_inv$HIV_pos[1]`-fold reduction for HIV-infected patients. Having both a negative Smear and MGIT was associated with a `r round(1/.4,2)` times lower probability of TBM. With all tests negative, the TBM probability reduced by `r post_test_tbl_inv$HIV_neg[5]` and `r post_test_tbl_inv$HIV_pos[5]` for HIV negative and positive respectively. 

```{r tbl-post-test, tab.cap="Average changes in TBM probability given available test result(s), relative to pre-confirmatory test TBM probability. Assume pre-test risk is 1, the values measure post-test risk in each scenario.", tab.id = "tbl-post-test"}
flextable::flextable(post_test_tbl) |> 
  flextable::set_header_labels(values=list(Scenario="Scenario", HIV_neg="HIV (-)", HIV_pos="HIV (+)")) |>
  flextable::bold(j= 1) |>
  flextable::width(width = c(1, 0.7, 0.7, 0.7, 1.5, 1.5)) |>
  flextable::theme_vanilla() |>
  flextable::align(i=1, part='header', align='center') |>
  flextable::align(j=1:4, part='body', align='center') |>
  flextable::add_footer_row(top=F, values="Values are in the form Mean (95% Credible interval)", colwidths = 6)
```

\newpage

```{r fit-post-test-change, fig.align='center', fig.cap='Changes in TBM risk over time in a hypothetical scenario when ZN Smear, Xpert, and MGIT culturing sequentially returned negative', fig.dim=c(10,5), dpi=600, message=FALSE, warning=FALSE, include=F, eval=F}
post_test$data = post_test$fit@frame |>
  filter(
    time %in% c("no_test", "smear_neg", "smear_xpert_neg", "all_neg")
  ) %>%
  mutate(
    time = factor(time, levels = c("no_test", "smear_neg", "smear_xpert_neg", "all_neg")),
    value = 2^`log2(value)`
  )

ggplot(data=post_test$data, aes(x = time, y = value, color=hiv)) + 
  geom_boxplot() + 
  scale_x_discrete(label = c("Pre-test", "Smear returned (-)", "Smear & Xpert returned (-)", "All returned (-)"), name="Timeline") +
  scale_y_continuous(breaks = seq(0,1,.25), labels = paste(seq(0,1,.25)*100, '%'), name = "TBM probability") +
  scale_color_discrete(name="HIV status", labels = c("Negative", "Positive")) + 
  theme_bw()
```

## Simplified model

In the simplified model, HIV infection and longer symptom duration at hospitalisation were associated with a TBM diagnosis (Figure \@ref(fig:simplified-model-plot)). Local neurological deficit and cranial nerve palsy, without the existence of laboratorial tests, both showed as positive risk factors. Headache was shown as a marker for TBM, opposite to pyschosis. Our simplified model had good AUC against binary class generated from our prevalence model. The best cut-point maximising Youden's index of 23.5% had sensitivity of 75.0% and specificity of 73.7%. We built a screening score table by selecting rounded values within the 50% credible intervals of every coefficient (Table \@ref(tab:score-table)). Continuous values were cut into bins so that each bin accounts for 0.5 points in the scoring table.


```{r simplified-model-plot, fig.align='center', fig.cap="A: Posterior estimates of coefficients of clinical TBM risk factors. Points, thick lines, and thin lines are posterior means, 50\\% and 95\\% credible intervals. B: Calibration plot of the simplified model, expected posterior probability of prevalence model. “Observed” probabilities are defined as values smoothed by a loess fit against observed binary events, in which the translucent ribbons represent the level of uncertainty of the smoothing. C: ROC plot and AUC of the simplified model, against hospital diagnosis. AUC values are presented as \\emph{“average (min - max over 20 repetitions of cross-validation)”}.", message=FALSE, warning=FALSE, out.width='100%', dpi=600, fig.dim=c(9, 8), fig.id = "simplified-model-plot"}
# tmp_svg <- cowplot::ggdraw() + 
#   cowplot::draw_image(magick::image_read_svg("includes/a_plog_s.svg", width=212*5, height=159*5))
# plot(tmp_svg)
s_plots <- readRDS(file.path(data_dir, '..', 'export', 'a_plot_s.RDS'))
a_plot_s <- s_plots$a_plot_s + 
  theme(
    #text = element_text('serif', size = 10), 
    #plot.tag = element_text('serif', size = 10), 
    axis.text.y = ggtext::element_markdown(family=NULL, face='bold'), legend.position = "none") 
metrics_s <- readRDS(file.path(data_dir, '..', 'export', 'metrics', 's_plot.RDS')) 

(a_plot_s + (metrics_s$calib/ (metrics_s$roc))) + plot_annotation(tag_levels = 'A')
```

```{r score-table, tab.cap="Simplified scoring table", tab.id = "score-table"}

m = data.frame(
  Criterion = c(
    'HIV',
    'TB-suggested symptoms',
    'Local neurological deficit',
    'Cranial nerve palsy',
    'Past noticed TB contact',
    rep('Glasgow coma score',6),
    'Pulmonary TB/X-ray',
    'Miliary TB/X-Ray',
    rep('Days from onset',6),
    'Headache',
    'Pyschosis'),
  Estimated = s_plots$a_plot_s3$data |> filter(parameter %in% paste0('a[',c(1:5, 9, 6:8, 10:11),']')) %>% .$m %>% round(2) %>% (\(x) {c(x[1:5], rep(x[6],6),x[7:8], rep(x[9],6), x[10:11])}),
  Value  = c(
    rep('+',5),
    '3-5',
    '6-7',
    '8-9',
    '10-11',
    '12-13',
    '14-15',
    rep('+', 2),
    '<1',
    '1-2',
    '3-6',
    '7-14',
    '15-30',
    '31+',
    rep('+', 2)
    # '63+',3
  ),
  # Score = c(1, 0.5, 0, 0.5, 0.5, "GCS/5",  1.5, 1, "$log_2$(Number of days)/2", .5, -.1)
  Score = c(0.5, 0.5, 1, 0, 1.5, 1, 1.5, 2, 2.5, 3, 3.5, 1.5, 1.5, 0, .5, 1, 1.5, 2, 2.5, .5, -.5)
  
)
flextable::flextable(m) |>
  flextable::add_footer_row(top=FALSE, 
                            values = glue::glue("TBM suspected: > {((qlogis(.283) - s_plots$a_plot_s3$data$m[1])/0.5) |> round(0) |> (\\(x) x * 0.5)()}"),
                            colwidths = 4) |>
  flextable::merge_v(j=c(1,2)) |>
  flextable::set_header_labels(Estimated = 'Model estimate') |>
  ftExtra::colformat_md(j=c(1,2)) |>
  flextable::width(width=1.1) |>
  flextable::theme_vanilla()


```
