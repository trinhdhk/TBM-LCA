# Results

```{r calc_na}
suspected_hiv <- data_dirty |> filter(DISDIA %in% c('DIA1', 'DIA10', 'DIA12'))
n_test_suspected_hiv <- nrow(suspected_hiv) - na(suspected_hiv$hiv_stat)
```

## Clinical characteristics

From 29th August 2017 to 22nd January 2021, there were `r nrow(data_dirty)` patients with suspected brain infection enrolled into study. `r nrow(data_19EI)` were included in the analysis (figure \@ref(fig:patient-flow)). 

```{r echo=FALSE}
var = c()
var[1] <- nrow(data_dirty)
var[2] <- sum(is.na(data_dirty$wrong_name) | data_dirty$wrong_name, na.rm=TRUE)
var[3] <- data_dirty[, sum((wrong_name%in%F) & (Volume<3)%in%TRUE)]
var[4] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    (is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[5] <- with(data_dirty,sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    !(is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[6] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    csf_mgit_contaminated, na.rm=TRUE))
var[7] <- with(data_dirty,  sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    !(csf_mgit_contaminated %in% T) &
    (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
    ((csf_smear%in%T)|(csf_mgit%in%T)|(csf_xpert%in%T)), na.rm=TRUE))
var[8] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      !(other_dis_dx_conf%in%T)&
      !((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
var[9] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE)  &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)&
      (other_dis_dx_conf%in%T),
    na.rm=TRUE))
var[10] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) & 
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert) &
      !(other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[11] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      (other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[12] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      # !(other_dis_dx_conf%in%T)&
      ((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
```

Characteristics of analysed population are shown in table \@ref(tab:test-bl-tbl). There were no significant different in the age of different groups, with the mean of `r quantile(data_dirty$age, .5, na.rm=TRUE) |> round(1)`. HIV were tested for `r nrow(data_dirty) - na(data_dirty$hiv_stat)` (`r round((nrow(data_dirty) - na(data_dirty$hiv_stat))/nrow(data_dirty)*100, 0)`%) enrolled individuals.  <!-- As HIV was only tested for suspected patients who admitted with HIV-related conditions or involved in high-risk activities, we assumed the HIV rate for the untested group to be similar to that of the general population. Missing GCSV due to intubation is a common issue and the practice of using a model-based imputation approach is supported[@Teasdale2014], as all the Glasgow Coma Scale components are usually highly correlated.--> Both HIV prevalence and duration from symptom onset in the test positive groups were consistently higher than those in the test negative groups. Overall, there were `r var[5]` participants with valid TBM confirmatory tests, `r var[7]` were microbiology confirmed \@ref(fig:venn-test). `r var[11]` were later confirmed with another disease. In the untested group, `r var[9]` were microbiologically diagnosed with non-*Mtb* infection There were `r var[8]+var[10]` patients were not confirmed with any condition.

```{diagrammer patient-flow, fig.show="hold", out.width="100%", out.height="10cm",  fig.align="center", fig.cap="Recruited patient profile", fig.id="patient-flow"}
digraph patientflow {
  # compound = true;
  graph[dpi = 300, fontname="CMU Serif", splines=line];
  node[fontname = "CMU Serif", shape='rectangle'];
  # edge[splines=line]
  
  Total [label = "@@1 enrolled and have CSF samples collected" ]
  
  subgraph exclude1{
    WrongName [label ="@@2 excluded due to mis-matched names"]
    LowVolume [label = "@@3 excluded due to low CSF volume collected"]
    Contaminated [label = "@@6 excluded due to contaminated culture"]
  }
  
  NotTested [label = "@@4 not tested for TBM"]
  Tested [label = "@@5 tested for TBM"]
  # {rank=same; WrongName; LowVolume}
  {rank=same; Tested; NotTested}
  
  TBM [label = "@@7 confirmed TBM\l\n@@12 suspected TBM\l\n@@11 confirmed other cause\l\n@@8 unconfirmed cause\l"]
  NotTBM [label = "@@9 confirmed other disease\l\n@@10 unconfirmed cause\l"]
  {rank=same; TBM; NotTBM};
  
  WrongName:s -> LowVolume:n[style=invis]
  LowVolume:s -> Contaminated:n[style=invis]
  LowVolume:e -> Tested:w[style=invis]
  Total:s -> WrongName:e
  Total:s -> LowVolume:e
  Total:s -> NotTested:n
  Total:s -> Tested:n
  NotTested:s -> NotTBM:n
  Tested:s -> TBM:n
  Tested:s -> Contaminated:e
  Contaminated:e -> TBM:w[style=invis]
  # Contaminated:s -> NotTBM:n[style=invis]
}
[1]: var[1]
[2]: var[2]
[3]: var[3]
[4]: var[4]
[5]: var[5]
[6]: var[6]
[7]: var[7]
[8]: var[8]
[9]: var[9]
[10]: var[10]
[11]: var[11]
[12]: var[12]
```

```{r venn-test, out.width='50%', fig.align='center', fig.asp=1, fig.cap = 'Venn diagram for ZN Smear, MGIT, and Xpert'}

data_19EI |>
  mutate(across(c(csf_smear, csf_mgit, csf_xpert), as.logical)) |>
  ggplot() +
  ggvenn::geom_venn(aes(A = csf_smear, B = csf_mgit, C = csf_xpert), 
                    fill_color = c('#E5707E', '#E6B566', '#A3DDCB'),
                    stroke_color = c('#E5707E', '#E6B566', '#A3DDCB'),
                    set_names = c('ZN Smear', 'MGIT', 'Xpert'),
                    text_size = 3, set_name_size = 4) +
  theme_void()

```

\newpage

\blandscape

<!---BLOCK_LANDSCAPE_START--->

```{r test-bl-tbl, echo=FALSE, tab.cap="Baseline characteristics of all study patients", tab.id="test-bl-tbl"}
bl_tbl <- 
  data_dirty |>
  as_tibble() |>
  mutate(csf_neutro = csf_wbc - csf_lympho - csf_eos) |>
  mutate(
    across(c(csf_smear, csf_xpert, csf_mgit), 
           ~ factor(.x, 
                    levels = c(TRUE, FALSE,NA), 
                    labels = c('Positive', 'Negative', 'Missing'),
                    exclude = NULL
           )
    )
  ) |>
  select(age, hiv_stat, clin_illness_day, clin_symptoms, clin_contact_tb, clin_motor_palsy, clin_nerve_palsy, clin_gcs, xray_pul_tb, xray_miliary_tb, csf_lympho, csf_wbc, csf_eos, csf_rbc, csf_protein, csf_lactate, csf_glucose, bld_glucose = BLDGLU, csf_crypto, csf_smear, csf_xpert, csf_mgit) |>
  tidyr::pivot_longer(
    c(csf_smear, csf_mgit, csf_xpert),
    names_to = 'Test',
    values_to = 'Result'
  ) |>
  my_fn$add_labels(
    age               = 'Age',
    hiv_stat          = 'HIV Positive', 
    clin_illness_day  = 'Symptom duration',
    clin_symptoms     = 'TB-suggested systemic symptoms',
    clin_contact_tb   = 'Past noticeable contact TB within 12 months',
    clin_motor_palsy  = 'Focal neurological deficit',
    clin_nerve_palsy  = 'Cranial nerve palsy',
    # GCSV              = 'Glasgow Coma Scale-Verbal',
    # GCSM              = 'Glasgow Coma Scale-Motor',
    # GCSE              = 'Glasgow Coma Scale-Eyes',
    clin_gcs          = 'Glasgow Coma Score',
    xray_pul_tb       = 'X-Ray Pulmonary TB (not Miliary TB)',
    xray_miliary_tb   = 'X-Ray Miliary TB',
    csf_lympho        = 'CSF Lymphocyte Count',
    csf_wbc           = 'CSF Total White cell Count',
    # csf_neutro        = 'CSF Neutrophil Count',
    csf_eos           = 'CSF Eosinophil Count',
    csf_rbc           = 'CSF Red blood cell Count',
    csf_protein       = 'CSF Protein',
    csf_lactate       = 'CSF Lactate',
    csf_glucose       = 'CSF Glucose',
    bld_glucose       = 'Corresponding Blood Glucose',
    csf_crypto        = 'Cryptococcal Antigen/Indian Ink'
  ) |>
  # mutate(- csf_neutro) |>
  mutate(
    Test = case_when(
      Test == 'csf_smear' ~ 'ZN Smear',
      Test == 'csf_mgit'  ~ 'MGIT',
      Test == 'csf_xpert' ~ 'Xpert (Ultra)',
    )
    # Result = ifelse(is.na(Result), 'Missing', Result) |> factor()
  ) |>
  tbl_strata(
    strata = Test,
    .tbl_fun = ~ tbl_summary(
      .x, 
      by = Result,
      missing_text = '  - Missing',
      # type = list(GCSV~'continuous', GCSE~'continuous',GCSM~'continuous'),
      statistic = list(
        all_continuous() ~ '{mean} ({p25}, {p75})'),
      digits = list(csf_eos ~ c(0, 0, 0), clin_gcs ~ c(0, 0, 0))
    )
  ) |>
  modify_footnote(
    update = all_stat_cols() ~ "Mean (1st, 3rd quartiles) for numeric variables; n (%) for categorical variables",
    text_interpret = "html"
  )

bl_tbl |> as_flex_table() |>
  # flextable::set_caption('Baseline characteristics') |>
  flextable::width(width = .88) |>
  flextable::fontsize(size=9, part = 'all') |>
  flextable::theme_vanilla()
```

<!---BLOCK_LANDSCAPE_STOP--->

\elandscape

\newpage

```{r missing-handling,eval=FALSE, include=FALSE, tab.cap="Rationales and measures to handle missing values", tab.id="missing-handling"}
na = \(x) sum(is.na(x))
data_dirty$csf_neutro <- data_dirty$NEUPER * data_dirty$csf_wbc / 100
data_dirty %$%
  tibble::tribble(
     ~ 'Variable'           , ~ 'N\n missing'     ,  ~ 'Expected Reason of Missingness'                      , ~ 'Mechanism',        ~ 'Handling method' ,
    'ZN Smear'              , na(csf_smear)       , 'Not suspected TBM'                                      , 'MNAR'               , 'Set = 0'          , 
    'MGIT'                  , na(csf_mgit)        , 'Not suspected TBM'                                      , 'MNAR'               , 'Set = 0'          , 
    'Xpert'                 , na(csf_xpert)       , 'Not suspected TBM'                                      , 'MNAR'               , 'Set = 0'          , 
    'HIV Status'            , na(hiv_stat)        , 'Not suspeted HIV'                                     , 'MNAR'           , 'Impute by population prevalence'       ,
    'TB-systemic symptoms' , na(clin_symptoms)   , 'Unmeasured / Unnoticed / Unconscious'                   , 'MAR'           , 'Imputation'       ,
    'Local neuro-deficit'   , na(clin_motor_palsy), 'Unconscious'                                            , 'MAR/MNAR'           , 'Imputation'       ,
    'Glasgow Coma Score'    , na(clin_gcs)        , 'Intubated / Forgot'       , 'MAR'                , 'Imputation'       ,
    'Age'                   , na(age)             , 'Input error'                                            , 'MCAR'              , 'Imputation'       ,
    'Illness days'          , na(clin_illness_day), 'Patients forget / Unconscious'                          , 'MAR'                , 'Imputation'       ,
    'Blood Lymphocyte'      , na(LYMP)            , 'Unmeasured (premature death)'                           , 'MAR'                , 'Imputation'       ,
    'Blood Neutrophil'      , na(NEUTRO)          , 'Unmeasured (premature death)'                           , 'MAR'                , 'Imputation'       ,
    'Blood Glucose'         , na(BLDGLU)          , 'Most likely input error / Unmeasured (premature death)', 'MAR/MCAR'           , 'Imputation'       ,
    'CSF glucose'           , na(csf_glucose)     , 'Unmeasured (premature death)'                           , 'MAR/MCAR'           , 'Imputation'       ,
    'CSF lymphocyte count'  , na(csf_lympho)      , 'Very low or zero / Input error / Unmeasured (premature death)', 'MNAR/MAR'           , 'Manually set/Imputation',
    'CSF neutrophil count'  , na(csf_neutro)      , 'Very low or zero / Input error / Unmeasured (premature death)', 'MNAR/MAR'           , 'Manually set/Imputation',
    'CSF protein'           , na(csf_protein)     , 'Data input error / Test error'       , 'MAR/MCAR'           , 'Imputation'       ,
    'CSF lactate'           , na(csf_lactate)     , 'Data input error / Test error'                              , 'MAR/MCAR'           , 'Imputation'     
    # 'CSF RBC count'         , na(csf_rbc)         , 'Zero cell count'                                        , 'MNAR'               , 'Set = 0'                  
  ) |>
  flextable::flextable() |>
  # flextable::set_caption('Rationale and method of missing values handling') |>
  flextable::width(width = 1.25) |>
  flextable::footnote(i = c(14,15),j = 1,inline=FALSE,
                      value=flextable::as_paragraph(rep('CSF Cell counts = CSF white-cell count x Pct of Cell Type / 100; if very low, then either lymphocytes or neutrophils had values, the other were left missing')),
                      part = 'body') |>
  flextable::footnote(i = c(1),j = 1,inline=FALSE,
                      value=flextable::as_paragraph(rep('GCS Verbal is assumed to be MAR after correction for the other two, and is predicted by a model-based imputation[@Teasdale2014]')),
                      part = 'body') |>
  flextable::merge_v(part='footer') |>
  flextable::theme_vanilla() |>
  flextable::bold(bold=FALSE, part='footer') |>
  flextable::italic(italic=TRUE, part='footer')
```

## Model estimation

```{r est_fun, include=FALSE}
est = \(name, tab, digits=2, transformation = I, ci.sep = ', ', post.fn = I, pre.fn=I) {
  m <- c(pre.fn(tab[name, 'mean']), pre.fn(tab[name, '2.5%']), pre.fn(tab[name, '97.5%'])) |> transformation() 
  c(m[1]|> formatC(digits=digits, format='f') |> post.fn(),
    # m[2]|> formatC(digits=digits, format='f') |> post.fn(), 
    paste(min(m[2:3]) |> formatC(digits=digits, format='f') |> post.fn(), 
          max(m[2:3]) |> formatC(digits=digits, format='f') |> post.fn(), sep=ci.sep))
}

spc.est = purrr::partial(est,
                         transformation=\(x) 100*(1-x), ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))
sen.est = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))

spc.est2 = purrr::partial(est,
                         transformation=\(x)  100*(1-x), ci.sep=', ', digits=2)
sen.est2 = purrr::partial(est, transformation=\(x) 100*x, ci.sep=', ', digits=2)

sen = \(name, hiv=NULL, fn=sen.est) {
  name = paste0(name, '[2]')
  do.call(sprintf, as.list(c('%s (%s)', fn(name, 
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
}

spc = \(name, hiv=NULL, fn=spc.est) {
  name = paste0(name, '[1]')
  do.call(sprintf, as.list(c('%s (%s)', fn(name,
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
}
```

Posterior estimates for ZN Smear, MGIT, and Xpert performances against latent TBM status are reported in table \@ref(tab:mv-posterior). All confirmatory assays had over 99% specificity. Smear was the most sensitive test with `r sen('z_Smear', hiv=FALSE)` for HIV negative patients and `r sen('z_Smear', hiv=TRUE)` for HIV positive patients. Xpert was least sensitive, especially amongst HIV negative population, with only `r sen('z_Xpert', hiv=FALSE)`, but was significantly higher and comparable to that of culturing in HIV positive group: `r sen('z_Xpert', hiv=TRUE)`.

Estimated coefficients for TB risk factors are shown in figure \@ref(fig:coef-est). Patients with HIV, Miliary TB, long symptom duration, and past TBM contacts were in the higher risk group of TBM. Of the laboratory variables, increased TBM risk were associated with low CSF glucose, low paired Blood Glucose, and high CSF lymphocyte count. CSF protein and lactate showed minimal trends of positive association. Total white blood cells showed quadratic trends with peaked TBM risk at intermediate values.

Amongst the included bacillary burden impacting factors, HIV and higher CSF protein were both associated with higher burden, with glucose stood on the opposite side. Although higher lymphocyte count in CSF sample means a higher chance of TBM compared with other diagnoses, it was associated with a reduction in the expected mycobacterial burden, presumably a reduction of confirmatory test detection rates.

```{r mv-posterior, tab.cap="Posterior estimates of test sensitivities and specificities, for overall population, and stratified by HIV", tab.id="mv-posterior"}
# Use %
pr_neg <- matrix(c(
  c('Test', rep(c('Specificity (%)'),1), rep(c('Sensitivity (%)'),1)),
  # c('Test', rep(c('Estimates'),2)),
  c('Smear',
    # est('z_Smear[1]', tab = p_hiv_neg_summary,  transformation =\(x) 1-(x)), 
    # est('z_Smear[2]', tab = p_hiv_neg_summary)),
    spc("z_Smear", hiv=FALSE, fn=spc.est2),
    sen("z_Smear", hiv=FALSE, fn=sen.est2)),
  c('Mgit',
    # est('z_Mgit[1]', tab = p_hiv_neg_summary, transformation =\(x) 1-(x)), 
    # est('z_Mgit[2]', tab = p_hiv_neg_summary)),
    spc("z_Mgit", hiv=FALSE, fn=spc.est2),
    sen("z_Mgit", hiv=FALSE, fn=sen.est2)),
  c('Xpert',
    # est('z_Xpert[1]', tab = p_hiv_neg_summary, transformation =\(x) 1-(x)), 
    # est('z_Xpert[2]', tab = p_hiv_neg_summary))
    spc("z_Xpert", hiv=FALSE, fn=spc.est2),
    sen("z_Xpert", hiv=FALSE, fn=sen.est2))
), byrow=T, nrow=4)

pr_pos <- matrix(c(
  c('Test', rep(c('Specificity (%)'),1), rep(c('Sensitivity (%)'),1)),
  # c('Test', rep(c('Estimates'),2)),
  c('Smear',
    spc("z_Smear", hiv=TRUE, fn=spc.est2),
    sen("z_Smear", hiv=TRUE, fn=sen.est2)),
  c('Mgit',
    # est('z_Mgit[1]', tab = p_hiv_pos_summary, transformation =\(x) 1-(x)), 
    # est('z_Mgit[2]', tab = p_hiv_pos_summary)),
    spc("z_Mgit", hiv=TRUE, fn=spc.est2),
    sen("z_Mgit", hiv=TRUE, fn=sen.est2)),
  c('Xpert',
    # est('z_Xpert[1]', tab = p_hiv_pos_summary, transformation =\(x) 1-(x)), 
    # est('z_Xpert[2]', tab = p_hiv_pos_summary))
    spc("z_Xpert", hiv=TRUE, fn=spc.est2),
    sen("z_Xpert", hiv=TRUE, fn=sen.est2))
), byrow=T, nrow=4)

pr <- matrix(c(
  c('Test', rep(c('Specificity (%)'),1), rep(c('Sensitivity (%)'),1)),
  # c('Test', rep(c('Estimates'),2)),
  c('Smear',
    # est('z_Smear[1]', tab = p_summary,  transformation =\(x) 1-(x)), 
    # est('z_Smear[2]', tab = p_summary)),
    spc("z_Smear", hiv=NULL, fn=spc.est2),
    sen("z_Smear", hiv=NULL, fn=sen.est2)),
  c('Mgit',
    # est('z_Mgit[1]', tab = p_summary, transformation =\(x) 1-(x)), 
    # est('z_Mgit[2]', tab = p_summary)),
    spc("z_Mgit", hiv=NULL, fn=spc.est2),
    sen("z_Mgit", hiv=NULL, fn=sen.est2)),
  c('Xpert',
    # est('z_Xpert[1]', tab = p_summary, transformation =\(x) 1-(x)), 
    # est('z_Xpert[2]', tab = p_summary))
    spc("z_Xpert", hiv=NULL, fn=spc.est2),
    sen("z_Xpert", hiv=NULL, fn=sen.est2))
), byrow=T, nrow=4)

huxtable::as_hux(cbind(pr, pr_neg[,-1], pr_pos[,-1])) |>
  huxtable::as_flextable() |>
  flextable::add_header_row(values=c("", rep("Overall",2), rep("HIV (-)",2), rep("HIV (+)",2))) |>
  # flextable::merge_h(i=1, part='body') |>
  flextable::merge_h(i=1, part='header') |>
  flextable::width(width = 1) |>
  flextable::bold(i=1) |>
  flextable::theme_vanilla() |>
  flextable::align(i=1, align='center') |>
  flextable::align(i=1, align='center', part='header') |>
  flextable::add_footer_row(top=F, values="Values are in the form Mean (95% Credible interval)", colwidths = 7)
```

```{r coef-est, out.width='100%', fig.align='center', fig.asp=1.4, fig.cap = 'Posterior estimaties or coefficients of TBM risk factors and bacillary burden impacting variables, on matched and original scales. Points, thick lines, and thin lines are posterior means, 50\\% and 95\\% credible intervals'}
(a_plot + ggtitle('TBM Risk factor')) /
  (b_plot + ggtitle('Bacillary burden predictors')) + 
  plot_layout(nrow=2, heights=c(7,2))&
  theme(text = element_text('serif', size = 9), plot.tag = element_text('serif', size = 9), axis.text.y = ggtext::element_markdown(family=NULL, face='bold'), legend.position = "none") 
```

## Model validation 

Selected model showed good discrimination with cross-validated AUCs of `r classifierplots:::calculate_auc(test.y = data_19EI$csf_smear, pred.prob = m3$p$p_Smear$mean) |> round(0)`% for ZN Smear, `r classifierplots:::calculate_auc(test.y = data_19EI$csf_mgit, pred.prob = m3$p$p_Mgit$mean) |> round(0)`% for culturing, and  `r classifierplots:::calculate_auc(test.y = data_19EI$csf_xpert, pred.prob = m3$p$p_Xpert$mean) |> round(0)`% for Xpert (figure \@ref(fig:best-metrics)). The model was decently calibrated, estimated probabilities and observed frequency of test positive showed overall agreement [@VanCalster2019], with slight drop at the upper tail of for MGIT culturing and Xpert. The AUC for TBM prediction against hospital diagnosis were  `r classifierplots:::calculate_auc(test.y = !data_19EI$other_dis_dx, pred.prob = m3$p$theta$mean) |> round(2)`% and calibration plots show over-estimation at the centre (figure \@ref(fig:theta-metrics)). 

```{r best-metrics, fig.align='center', fig.cap='ROC curves (upper half) and calibration plots (lower half) for the selected model, against observed test results. Results from individual CV repetitions are shown in fainted grey and the average curves are in colour.', fig.dim=c(8,6), dpi=600, message=FALSE, warning=FALSE, out.width='90%'}
m3_roc = readRDS(file.path(data_dir, '..', 'export', 'm3_roc.RDS')) 
m3_calib = readRDS(file.path(data_dir, '..', 'export', 'm3_calib.RDS')) 
w = wrap_plots(m3_roc$Y, m3_calib$Y, ncol=1, heights=c(1,1))
plot(w)
```

```{r theta-metrics-prep, include=FALSE}
theta_rocs <- m3_roc$C + ggtitle('Hospital Diagnosis') + theme_bw()
theta_calib <- m3_calib$C
```

```{r theta-metrics, fig.align='center', fig.cap='ROC curves and calibration plots for selected model againts discharge diagnosis. Results from individual CV repetitions are shown in fainted grey and the average curves are in colour.', fig.dim=c(10,5), dpi=600, message=FALSE, warning=FALSE, out.width='100%'}
theta_rocs+theta_calib
```
## Changes of TBM risk Post confirmatory test negative

```{r load-fit, include=FALSE}
post_test = list()
# post_test$fit <- readRDS(file.path(data_dir, '..', 'export', 'post_test.RDS'))$fit2
# post_test$est <- coef(summary(post_test$fit))[, 'Estimate']
# post_test$confint <- confint(post_test$fit)
post_test$dat <- readRDS(file.path(data_dir, '..', 'export', 'post_test_fraction.RDS'))
post_test$get_sample <- function(name, hiv=FALSE){
  n = switch(name, 
             smear = 'a', xpert = 'b', smear_mgit = 'c', smear_xpert = 'd', all = 'e')
  with(post_test, {
    hiv.pop = dat$hiv == hiv
    target.pop = dat[[n]]
    # if (inv) target.pop = 1/(target.pop)
    target.pop[!hiv.pop] = NA
    apply(target.pop,1,mean,na.rm=T)
  })
}

post_test$get_est <- function(name, hiv=FALSE, inv=FALSE){
  est = post_test$get_sample(name, hiv)
  f = if (inv) {\(x) 1/x} else I
  
  mean = mean(est) |> f() |> formatC(digits=2, format='f')
  ci = quantile(est, c(.025, .975)) |> f() |> sort() |> formatC(digits=2, format='f')
  glue::glue('{mean} ({ci[[1]]} - {ci[[2]]})')
}

# post_test$get_est <- function(name, hiv = FALSE, inv=FALSE){
#   if (inv){ 
#     f = \(x) -x
#     first = "97.5 %"
#     second = "2.5 %"
#   } else {
#     f = \(x) x
#     first = "2.5 %"
#     second = "97.5 %"
#   }
#   name = paste0("time", name, "_neg")
#   if (!hiv) return (glue::glue("{round(2^f(post_test$est[name]),2)} ({round(2^f(post_test$confint[name, first]),2)}, {round(2^f(post_test$confint[name,second]),2)})"))
#   name2 = paste0(name,":hivTRUE")
#   glue::glue("{round(2^f(post_test$est[name]+post_test$est[name2]),2)} ({round(2^f(post_test$confint[name,first]+post_test$confint[name2,first]),2)} -  {round(2^f(post_test$confint[name,second]+post_test$confint[name2,second]),2)})")
# }
# post_test_tbl <- data.frame(Scenario = NULL, HIV_neg = NULL, HIV_postivive=NULL)
post_test_tbl = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-', '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-', '-'),
    HIV_neg = c(post_test$get_est("smear"),
                post_test$get_est("xpert"), 
                post_test$get_est("smear_mgit"), 
                post_test$get_est("smear_xpert"),
                # post_test$get_est("mgit_xpert"),
                post_test$get_est("all")
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE),
                post_test$get_est("xpert", hiv=TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE),
                post_test$get_est("all", hiv=TRUE))
  )

post_test_tbl_inv = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-',  '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-','-'),
    # Scenario = c("Smear (-)", "Xpert (-)", 
    #              "Smear & MGIT (-)", "Smear & Xpert (-)", "Xpert & MGIT (-)",
    #              "All tests (-)"),
    HIV_neg = c(post_test$get_est("smear", inv = TRUE),
                post_test$get_est("xpert", inv = TRUE), 
                post_test$get_est("smear_mgit", inv = TRUE), 
                post_test$get_est("smear_xpert", inv = TRUE),
                # post_test$get_est("mgit_xpert", inv = TRUE),
                post_test$get_est("all", inv = TRUE)
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE, inv = TRUE),
                post_test$get_est("xpert", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE, inv = TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE, inv = TRUE),
                post_test$get_est("all", hiv=TRUE, inv = TRUE))
  )
```
 
<!--Figure \@ref(fig:fit-post-test-change) demonstrates TBM probability in our population given a chronological scenario where ZN Smear, Xpert, and MGIT culture results sequentially returned negative over time. --> Change in TBM probability relative to pre-test values are shown in table \@ref(tab:tbl-post-test). Briefly, a negative Smear only was associated with `r post_test_tbl_inv$HIV_neg[1]`-fold reduction in TBM risk for HIV-uninfected patients and `r post_test_tbl_inv$HIV_pos[1]`-fold reduction for HIV-infected. Combined negative Smear and MGIT was associated with roughly `r round(1/.4,2)` times lower probability of TBM. With all tests negative, the TBM probability reduced by `r post_test_tbl_inv$HIV_neg[5]` and `r post_test_tbl_inv$HIV_pos[5]` for HIV negative and positive respectively. 

```{r tbl-post-test, tab.cap="Average changes in TBM probability given available test result(s), relative to pre-confirmatory test TBM probability. Assume pre-test risk is 1, the values measure post-test risk in each scenario.", tab.id = "tbl-post-test"}
flextable::flextable(post_test_tbl) |> 
  flextable::set_header_labels(values=list(Scenario="Scenario", HIV_neg="HIV (-)", HIV_pos="HIV (+)")) |>
  flextable::bold(j= 1) |>
  flextable::width(width = c(1, 0.7, 0.7, 0.7, 1.5, 1.5)) |>
  flextable::theme_vanilla() |>
  flextable::align(i=1, part='header', align='center') |>
  flextable::align(j=1:4, part='body', align='center') |>
  flextable::add_footer_row(top=F, values="Values are in the form Mean (95% Credible interval)", colwidths = 6)
```

\newpage

```{r fit-post-test-change, fig.align='center', fig.cap='Changes in TBM risk over time in a hypothetical scenario when ZN Smear, Xpert, and MGIT culturing sequentially returned negative', fig.dim=c(10,5), dpi=600, message=FALSE, warning=FALSE, include=F, eval=F}
post_test$data = post_test$fit@frame |>
  filter(
    time %in% c("no_test", "smear_neg", "smear_xpert_neg", "all_neg")
  ) %>%
  mutate(
    time = factor(time, levels = c("no_test", "smear_neg", "smear_xpert_neg", "all_neg")),
    value = 2^`log2(value)`
  )

ggplot(data=post_test$data, aes(x = time, y = value, color=hiv)) + 
  geom_boxplot() + 
  scale_x_discrete(label = c("Pre-test", "Smear returned (-)", "Smear & Xpert returned (-)", "All returned (-)"), name="Timeline") +
  scale_y_continuous(breaks = seq(0,1,.25), labels = paste(seq(0,1,.25)*100, '%'), name = "TBM probability") +
  scale_color_discrete(name="HIV status", labels = c("Negative", "Positive")) + 
  theme_bw()
```

## Simplified model

In the simplified model, HIV+ and symptom duration from onset were associated with a TBM diagnosis (figure \@ref(fig:simplified-model-plot)). Local neurological deficit and cranial nerve palsy, without the existence of laboratorial tests, both showed as positive risk factors, similarly to two additional signs (headache and psychosis). Our simplified model had good AUC against held-out hospital diagnosis. The best cut-point maximising Youden's index of 30.4% had sensitivity of 76.7% and specificity of 79.1%. Based on the cut-point provided a simplified scoring system for an easy estimation of TBM risk at admission.


```{r simplified-model-plot, fig.align='center', fig.cap='Left: Posterior estimates of coefficients of clinical TBM risk factors. Points, thick lines, and thin lines are posterior means, 50\\% and 95\\% credible intervals. Right: ROC curves (upper half) and calibration plots (lower half) for the selected model, against observed test results. Results from individual CV repetitions are shown in fainted grey and the average curves are in colour', message=FALSE, warning=FALSE, out.width='100%', dpi=600, fig.dim=c(8, 6), fig.id = "simplified-model-plot"}
# tmp_svg <- cowplot::ggdraw() + 
#   cowplot::draw_image(magick::image_read_svg("includes/a_plog_s.svg", width=212*5, height=159*5))
# plot(tmp_svg)
a_plot_s <- readRDS(file.path(data_dir, '..', 'export', 'a_plot_s.RDS')) + theme(text = element_text('serif', size = 9), plot.tag = element_text('serif', size = 9), axis.text.y = ggtext::element_markdown(family=NULL, face='bold'), legend.position = "none") 
metrics_s <- readRDS(file.path(data_dir, '..', 'export', 'metrics', 's1_plots.RDS')) 

plot(a_plot_s + ((metrics_s$calib + ggtitle("Hospital Diagnosis"))/ (metrics_s$roc + ggtitle(''))))
```

```{r score-table, tab.cap="Simplified scoring table", tab.id = "score-table"}
m = data.frame(
  Criterion = c(
    'HIV +',
    'TB-suggested symptoms',
    'Local neurological deficit',
    'Cranial nerve palsy',
    'Past noticed TB contact',
    'Glasgow coma score',
    'Pulmonary TB/X-ray',
    'Miliary TB/X-Ray',
    'Days from onset',
    'Headache',
    'Pyschosis'),
  Estimate = a_plot_s$data |> filter(parameter %in% paste0('a[',c(1:5, 9, 6:8, 10:11),']')) %>% .$m %>% round(2),
  Score = c(2, -0.5, 0, 0.5, 0.5, "GCS/2",  2, 0.5, "$log_2$(Number of days)/2", .75, -.25)
)
flextable::flextable(m) |>
  flextable::add_footer_row(top=FALSE, 
                            values = glue::glue("TBM suspected: > {(qlogis(.304) - a_plot_s$data$m[1] - a_plot_s$data$m[1]*a_plot_s$data$m[7]*4.476003 - a_plot_s$data$m[1]*a_plot_s$data$m[10]*2.241451) |> round(2)}"),
                            colwidths = 3) |>
  ftExtra::colformat_md(j=c(1,3)) |>
  flextable::width(width=1.5) |>
  flextable::theme_vanilla()


```
