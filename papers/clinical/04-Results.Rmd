# Results

```{r calc_na}
suspected_hiv <- data_dirty |> filter(DISDIA %in% c('DIA1', 'DIA10', 'DIA12'))
n_test_suspected_hiv <- nrow(suspected_hiv) - na(suspected_hiv$hiv_stat)
```

## Clinical characteristics

A total of `r nrow(data_dirty)` patients with suspected brain infection enrolled into the study. Of these,  `r nrow(data_19EI)` were included in the analysis. Reasons for exclusion are shown in Figure \@ref(fig:patient-flow). Characteristics of included individuals are summarised in table \@ref(tab:test-bl-tbl), stratified by confirmatory test results. The mean age of included individuals was `r quantile(data_19EI$age, .5, na.rm=TRUE) |> round(1)`, with little variation. HIV co-infection status was recorded for `r nrow(data_19EI) - na(data_19EI$hiv_stat)`/`r nrow(data_19EI)` (`r round((nrow(data_19EI) - na(data_19EI$hiv_stat))/nrow(data_19EI)*100, 0)`%) enrolled individuals. Both HIV prevalence and duration from symptom onset to hospitalisation in any test positive group was consistently higher than those in the other. Overall, there were `r var[5]` participants with valid TBM confirmatory tests, `r var[7]` were microbiologically confirmed (Figure \@ref(fig:venn-test)), while `r var[11]` were later confirmed with another disease. In the group not tested for TBM, `r var[9]` patients were microbiologically diagnosed with another pathogen than *Mtb*. For `r var[8]+var[10]` patients no confirmed diagnosis could be made, but they were unlikely to have TBM.

```{r echo=FALSE}
pop = data_dirty[,(wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    !(csf_mgit_contaminated %in% T) ]
var = c()
var[1] <- nrow(data_dirty)
var[2] <- sum(is.na(data_dirty$wrong_name) | data_dirty$wrong_name, na.rm=TRUE)
var[3] <- data_dirty[, sum(
  (wrong_name%in%F) & 
    ((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)))]
var[4] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    (is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[5] <- with(data_dirty,sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    !(is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[6] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    csf_mgit_contaminated, na.rm=TRUE))
var[7] <- with(data_dirty,  sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
    !(csf_mgit_contaminated %in% T) &
    (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
    ((csf_smear%in%T)|(csf_mgit%in%T)|(csf_xpert%in%T)), na.rm=TRUE))
var[8] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      !(other_dis_dx_conf%in%T)&
      !((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
var[9] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE))  &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)&
      (other_dis_dx_conf%in%T),
    na.rm=TRUE))
var[10] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) & 
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert) &
      !(other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[11] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      (other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[12] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE | ((diffday>=7) %in% TRUE)) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      # !(other_dis_dx_conf%in%T)&
      ((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
```

## Model estimates

```{r est_fun, include=FALSE}
est = \(name, tab, digits=2, transformation = I, ci.sep = ', ', post.fn = I, pre.fn=I) {
  m <- c(pre.fn(tab[name, c('mean', '50%')]), pre.fn(tab[name, '2.5%']), pre.fn(tab[name, '97.5%'])) |>
    unlist() |> 
    transformation() 
  c(m[1]|> formatC(digits=digits, format='f') |> post.fn(), 
    m[2]|> formatC(digits=digits, format='f') |> post.fn(),
    paste(min(m[3:4]) |> formatC(digits=digits, format='f') |> post.fn(), 
          max(m[3:4]) |> formatC(digits=digits, format='f') |> post.fn(), sep=ci.sep))
}

spc.est = purrr::partial(est,
                         transformation=\(x) 100*(1-x), ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))
sen.est = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))

spc.est2 = purrr::partial(est,
                         transformation=\(x)  100*(1-x), ci.sep=' - ', digits=1)
sen.est2 = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1)

sen = \(name, hiv=NULL, fn=sen.est, sep = ' ') {
  name = paste0(name, '[2]')
  out = do.call(sprintf, as.list(c('%s; %s (%s)', fn(name, 
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
  gsub('\\s\\(', paste0(sep, '('), out)
}

spc = \(name, hiv=NULL, fn=spc.est, sep = ' ') {
  name = paste0(name, '[1]')
  out = do.call(sprintf, as.list(c('%s; %s (%s)', fn(name,
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
  gsub('\\s\\(', paste0(sep, '('), out)
}
```

Posterior estimates of sensitivity and specificity of Smear, MGIT, and Xpert are reported in Table \@ref(tab:mv-posterior). All three had over 99% specificity. Smear was the most sensitive test with `r sen('z_Smear', hiv=FALSE)` for HIV negative patients and `r sen('z_Smear', hiv=TRUE)` for HIV positive patients. Xpert was the least sensitive, especially in HIV negative patients, with only `r sen('z_Xpert', hiv=FALSE)`, but its sensitivity was much higher and comparable to that of MGIT in the HIV positive group: `r sen('z_Xpert', hiv=TRUE)`.

Estimated coefficients for TB risk factors in the prevalence model are shown in Figure \@ref(fig:coef-est). Patients with HIV, miliary TB, and long symptom duration were in the higher risk group of TBM. Of the laboratory variables, increased TBM risk was associated with low CSF glucose, low paired blood glucose, high CSF protein, and high lactate, albeit not significant. Patients with approximately 200 WBC/mm^3^ in CSF were estimatedly at the highest risk. Amongst the factors that impact bacillary burden, HIV and higher CSF protein were both associated with higher burden, while glucose and WBC associated with lower burden. Although higher lymphocyte count in CSF relates to TBM, it was associated with a reduction in the expected mycobacterial burden, which reduced sensitivity.

## Model validation 

Our selected model with highest elpd of $-347.0$ ($SE=25.0$) showed good discrimination with cross-validated AUCs of `r classifierplots:::calculate_auc(test.y = data_19EI$csf_smear, pred.prob = m3$p$p_Smear$mean) |> round(0)`% for ZN Smear, `r classifierplots:::calculate_auc(test.y = data_19EI$csf_mgit, pred.prob = m3$p$p_Mgit$mean) |> round(0)`% for MGIT, and  `r classifierplots:::calculate_auc(test.y = data_19EI$csf_xpert, pred.prob = m3$p$p_Xpert$mean) |> round(0)`% for Xpert (Figure \@ref(fig:model-metrics)). The model was also well calibrated, estimated probabilities and smoothed frequency of positive tests showed overall agreement [@VanCalster2019], with a slight drop at the upper tail of for MGIT culturing and Xpert. The AUC of TBM prevalence model against hospital diagnosis was  `r classifierplots:::calculate_auc(test.y = !data_19EI$other_dis_dx, pred.prob = m3$p$theta$mean) |> round(0)`%. The calibration plot shows a good correspondence tiny over-estimation at the middle of the curve with intercept = -0.05 and slope = 0.95. 

## Updated estimated TBM risk if some or all confirmatory tests are negative

```{r load-fit, include=FALSE}
post_test = list()
post_test$dat <- readRDS(file.path(data_dir, '..', 'export', 'post_test_fraction.RDS'))
post_test$get_sample <- function(name, hiv=FALSE){
  n = switch(name, 
             smear = 'a', xpert = 'b', smear_mgit = 'c', smear_xpert = 'd', all = 'e')
  with(post_test, {
    hiv.pop = dat$hiv == hiv
    target.pop = dat[[n]]
    # if (inv) target.pop = 1/(target.pop)
    target.pop[!hiv.pop] = NA
    apply(target.pop,1,mean,na.rm=T)
  })
}

post_test$get_est <- function(name, hiv=FALSE, inv=FALSE){
  est = post_test$get_sample(name, hiv)
  f = if (inv) {\(x) 1/x} else I
  
  mean = mean(est) |> f() |> formatC(digits=2, format='f')
  ci = quantile(est, c(.025, .975)) |> f() |> sort() |> formatC(digits=2, format='f')
  glue::glue('{mean} ({ci[[1]]} - {ci[[2]]})')
}

post_test_tbl = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-', '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-', '-'),
    HIV_neg = c(post_test$get_est("smear"),
                post_test$get_est("xpert"), 
                post_test$get_est("smear_mgit"), 
                post_test$get_est("smear_xpert"),
                # post_test$get_est("mgit_xpert"),
                post_test$get_est("all")
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE),
                post_test$get_est("xpert", hiv=TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE),
                post_test$get_est("all", hiv=TRUE))
  )

post_test_tbl_inv = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-',  '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-','-'),
    HIV_neg = c(post_test$get_est("smear", inv = TRUE),
                post_test$get_est("xpert", inv = TRUE), 
                post_test$get_est("smear_mgit", inv = TRUE), 
                post_test$get_est("smear_xpert", inv = TRUE),
                # post_test$get_est("mgit_xpert", inv = TRUE),
                post_test$get_est("all", inv = TRUE)
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE, inv = TRUE),
                post_test$get_est("xpert", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE, inv = TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE, inv = TRUE),
                post_test$get_est("all", hiv=TRUE, inv = TRUE))
  )
```
 
<!--Figure \@ref(fig:fit-post-test-change) demonstrates TBM probability in our population given a chronological scenario where ZN Smear, Xpert, and MGIT culture results sequentially returned negative over time. --> The changes in probability to have TBM relative to the <!--?--> pre-test values are shown in Table \@ref(tab:tbl-post-test) for 5 scenarios mentioned in Section \@ref(stats-analysis). Having a negative Smear only was associated with a `r post_test_tbl_inv$HIV_neg[1]`-fold reduction in TBM risk for HIV-uninfected patients and a `r post_test_tbl_inv$HIV_pos[1]`-fold reduction for HIV-infected patients. Having both a negative Smear and MGIT was associated with a `r round(1/.4,2)` times lower probability of TBM. With all tests negative, the TBM probability reduced by `r post_test_tbl_inv$HIV_neg[5]` and `r post_test_tbl_inv$HIV_pos[5]` for HIV negative and positive respectively. 

## Simplified model

In the simplified model, HIV infection and longer symptom duration at hospitalisation were associated with a TBM diagnosis (Figure \@ref(fig:simplified-model-plot)). Local neurological deficit and cranial nerve palsy, without the existence of laboratorial tests, both showed as positive risk factors. Headache was shown as a marker for TBM, opposite to pyschosis. Our simplified model had good AUC against binary class generated from our prevalence model. The best cut-point maximising Youden's index of 23.5% had sensitivity of 75.0% and specificity of 73.7%. We built a screening score table by selecting rounded values within the 50% credible intervals of every coefficient (Table \@ref(tab:score-table)). Continuous values were cut into bins so that each bin accounts for 0.5 points in the scoring table.