---
title: 'In search of a novel scoring system for Tuberculous Meningitis Diagnosis: a Bayesian Latent Class Analysis Approach'
author:
  - Trinh Dong Huu Khanh:
      email: trinhdhk@oucru.org
      institute: [oucru, kcl]
      correspondence: true
  - Joseph Donovan:
      institute: [oucru, lshtm]
  - Guy Thwaites:
      institute: [oucru, oxford]
  - Ronald Geskus:
      institute: [oucru, oxford]
institute:
  - oucru: Oxford University Clinical Research Unit, Centre for Tropical Medicine, Ho Chi Minh City, Vietnam 
  - kcl: King's College London, London, United Kingdom
  - lshtm: London School of Hygiene and Tropical Medicine, London, United Kingdom
  - oxford: Centre for Tropical Medicine and Global Health, Nuffield Department of Medicine, University of Oxford, United Kingdom 
site: bookdown::bookdown_site
bibliography: includes/references.bib
csl: includes/clinical-infectious-diseases.csl
---

```{r setup, include=FALSE}
options(tinytex.engine_args = '-shell-escape')
knitr::opts_chunk$set(echo = FALSE, dpi=300) #, dev = 'png'
flextable::set_flextable_defaults(fonts_ignore=TRUE, font.size=9, table.layout='fixed')
```

```{r library, include=FALSE}
library(gtsummary)
library(dplyr)
library(data.table)
library(magrittr, include.only = '%$%')
library(ggplot2)
library(patchwork)
library(officedown)

# All the misc functions go here.
my_fn <- new.env()

## Add labels accross a tbl
my_fn$add_labels <- \(.data, ...){
  cols <- list(...)
  for (i in seq_along(cols))
    attr(.data[[names(cols)[i]]], 'label') <- cols[[i]]
  .data
}

## Register a knit engine for stan code highlight
my_fn$stan_knitr_engine <- \(options){
  out <- c('\\begin{Shaded}','\\begin{minted}{stan}', options$code, '\\end{minted}','\\end{Shaded}')
  options$echo <- FALSE
  options$results <- "asis"
  knitr::engine_output(options, options$code, out)
}
knitr::knit_engines$set(stan_code = my_fn$stan_knitr_engine)

## Gist to number equations
## https://gist.github.com/mcanouil/eb75057432ff77846f4273d8808e615a
my_fn$is_docx_output <- function (fmt = knitr:::pandoc_to()) {
  if (length(fmt) == 0) {
    return(FALSE)
  } else {
    return(fmt == "docx")
  }
}

my_fn$numberEq.docx <- function (eq, lab, envir = docx.eqcounter) {
  assign(x = "counter", value = get(x = "counter", envir = envir)+1, envir = envir)
  assign(x = gsub("eq:", "", lab), value = get(x = "counter", envir = envir), envir = envir)
  lab <- get("counter", envir = envir)
  return(c('$$', eq, '\\;\\;\\;\\;(', lab, ')', '$$'))
}
my_fn$labEq.docx <- function (lab, envir = docx.eqcounter) {
  return(paste0('(', get(x = gsub("eq:", "", lab), envir = envir), ')'))
}

docx.eqcounter <- new.env()
docx.eqcounter$counter <- 0
  
# Register a knit engine for formula
my_fn$aligned_formula_knit <- \(options){
  out <- my_fn$numberEq.docx(options$code, lab = options$fml.lab)
  options$echo <- FALSE
  options$results <- "asis"
  knitr::engine_output(options, options$code, out)
}
knitr::knit_engines$set(aligned_formula = my_fn$aligned_formula_knit)

# Register diagrammer graphviz
my_fn$diagrammer_engine <- \(options){
  grviz_opt = formals(DiagrammeR::grViz)
  grviz_opt = grviz_opt[names(grviz_opt) != 'diagram']
  new_opt = options[names(options) %in% names(grviz_opt)]
  # not_grviz_opt = opt[!names(opt %in% c('diagram', name(grviz_opt)))]
  grviz_opt = modifyList(grviz_opt, new_opt)
  dia_call <- purrr::partial(DiagrammeR::grViz, diagram = options$code)
  
  out <- do.call(dia_call, grviz_opt) 
  options$code <- out$x$diagram
  options$engine <- 'dot'
  options$echo <- FALSE
  knitr::knit_engines$get('dot')(options)
  # options$results <- 'asis'
  # knitr::engine_output(options, options$code, '')
}
knitr::knit_engines$set(diagrammer = my_fn$diagrammer_engine)

# Global theming for ggplots
my_fn$plot_theme <-
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

na = \(x) sum(is.na(x))

```

```{r data, include=FALSE}
data_dir <- '../../data/cleaned/'
load(file.path(data_dir, 'data_input.Rdata'))
data_dirty <- readRDS(file.path(data_dir, 'data_dirty.RDS'))
setDT(data_dirty)
load(file.path(data_dir, '..', 'export', 'm3_summary.Rdata'))
load(file.path(data_dir, '..', 'export', 'm3_plot.Rdata'))
m3 = readRDS(file.path(data_dir, '..', 'export', 'metrics', 'm3.RDS'))
```

<!--chapter:end:index.Rmd-->

# Abstract {.unnumbered}

### Background {-}

*Tuberculous meningitis* (TBM) is the one most mortal form of tuberculosis. Current expertise-based diagnosis comes with high uncertainty and performance of Ziehl-Neelsen smear (ZN Smear), cuturing, and GeneXpert are suboptimal. We developed a diagnosis model that provides a statistically calibrated scoring system, on full and simplified scales, estimations of individual TBM risk, bacillary burden, and sensitivity and specificity of current confirmatory tests amongst adults with suspected brain infection.

### Methods {-}

We included 658 subjects from a prospective observational study conducted at Ho Chi Minh city Hospital of Tropical diseases from 2007 to 2021. We used a Bayesian latent class regression model with local random effects. Models were validated internally and a Shiny app was provided.

### Results {-}

All current confirmatory had near perfect specificity. The sensitivity of ZN Smear was 71% (55%, 86%), culturing was 39% (23%, 55%), and GeneXpert was 23% (10%, 43%). Stratified by HIV status, ZN Smear was 69% (51%, 85%) sensitive, culturing was 35% (18%, 52%) sensitive, and GeneXpert was 18% (04%, 39%) sensitive for HIV negative population. All test sensitivities were better in HIV group at 93% (82%, 99%), 81% (58%, 96%), and 87% (56%, 100%), respectively. All model showed good discrimination and calibration. 

### Conclusion {-}

Our developed models could be objectively used as a decision assistants for clinicians to detect patients with high risk of TBM at different time points from early admission to later with test results.

<!--chapter:end:01-Abstract.Rmd-->

---
bibliography: includes/references.bib
---

# Introduction

*Tuberculous meningitis (TBM)* is the most lethal form of tuberculosis. The diagnosis of TBM is notoriously challenging, with microbiological confirmation requiring identification of very low numbers of *Mycobacterium tuberculosis* bacteria in cerebrospinal fluid (CSF). Bacterial detection methods include Ziehl-Neelsen (ZN) staining, GeneXpert MTB/RIF (Xpert), and Mycobacterial culture, but all lack sensitivity[@nhu2013; @chen2020]. Additional clinical information, such as the duration of illness and the characteristics of the CSF, may assist in the diagnosis and there have been a number of diagnostic algorithms created that utilise this information [@thwaites2002; @moreira2008; @marais2010; @le2020]. However, many of these algorithms were not validated thoroughly, especially for cases where all confirmatory tests returned negative.

The major challenge in the development and assessment of any new TBM diagnostic approaches is the absence of a gold standard. A uniform case definition was developed 10 years ago as a standardised approach to reporting TBM research[@marais2010], but it was developed by expert opinion, rather than by data analysis, and was never intended as a diagnostic tool and does not represent a gold standard. However, it illustrates the challenge presented by TBM.

The case definition allocates cases to one of four diagnostic levels: *definite*, *probable*, *possible*,
and *not TBM. Definite* TBM includes those cases with microbiologic or molecular confirmation of *M. tuberculosis* within the CSF. Typically, this represents around 30-40% of cases. The remaining cases are defined as *probable* or *possible,* encompassing an expert-generated scoring system where higher scores designate increased probability of a diagnosis of TBM. True TBM cases are likely represented by all *definite* cases, most *probable* cases, and some *possible* cases. Given TBM is almost always fatal if not treated with anti-tuberculosis drugs, and delayed treatment is strongly associated with death or severe neurological sequelae in survivors, physicians will usually opt to implicitly incorporate their experience to make the final decision. Under- and over-treatment are inevitable given the current inadequacy of diagnostic approaches.  

<!-- An alternative is to combine clinical and laboratory characteristics in a statistical model. In the absence of a gold standard, classical regression models do not suffice. *Latent Class Analysis (LCA)* is a technique which has been used for these settings. LCA is common in social science and psychology to detect different hidden traits[@Weller2020]. Recently, it has been adopted in several diagnostic studies, especially in Pulmonary Tuberculosis (PTB) and TBM[@schumacher2016; @stout2018; @lahuerta-marin2018; @adams2019].

We implemented a LCA -->
In this analysis, we aimed to *(1)* re-evaluate the performance, namely sensitivities and specificities, of current TBM confirmatory methods - ZN Smear, Xpert, and mycobacterial culture - against actual TBM status, taking into account the imperfection in current diagnosis; *(2)* develop a calibrated scoring system that estimates the probability of TBM based on individual characteristics. Our secondary objectives were to build a simplified scoring system that only needs clinical and demographic information so that TBM risk can be calculated at admission; and to estimate a latent representation of individual mycobacterial burden in the cerebrospinal fluid.

<!--chapter:end:02-Introduction.Rmd-->

# Methods

## Participants

We used data from an observational study of brain infection conducted on the neuro-infection ward of the Hospital for Tropical Diseases (HTD), Ho Chi Minh City, Vietnam. HTD is a 550-bed centre providing secondary and tertiary treatment for a wide range of tropical infections from all of southern Vietnam [@thwaites2002]. The study received ethical approvals from HTD and the Oxford Tropical Research Ethics Committee [@donovan2020]. Participants were enrolled between 29th August 2017 and 22nd January 2021. Inclusion criteria included a minimum age of 16 years, having suspected brain infection of any cause, and undergoing lumbar puncture at baseline as a routine diagnostic procedure. Patients were ineligible for enrolment if performing a lumbar puncture was contraindicated, or if informed consent to join the study was not given (by the patient, or by a relative if the patient lacked capacity to consent). Specifically for this analysis, we also excluded patients with contaminated mycobacterial culture results and with no subsequent culture in the first week since admission.

## Data collection and testing procedures

At enrolment time, demographic information and medical history were collected. HIV testing was performed on a case-by-case basis by the treating clinicians. Patients were tested for HIV if they presented with a condition suggestive of immune deficiency (e.g. tuberculosis, or cryptococcal meningitis) or had been involved in activities that increased HIV risk (e.g. injecting drug use). Patients with either known HIV infection or a new positive HIV test result, were considered HIV positive. Patients underwent clinical examination, chest X-Ray - but no brain imaging session, and laboratory investigations including blood tests, sputum ZN staining, and lumbar puncture, unless contra-indicated, with routine CSF analysis including white blood cells and cellular differential, CSF protein, CSF glucose (with paired blood glucose), and CSF lactate. Ideally at least 6mls CSF was used for mycobacterial testing by Ziehl--Neelsen (ZN) stain, mycobacterial culture using Mycobacteria Growth Indicator Tube (MGIT), and Xpert or Xpert MTB/RIF Ultra (XpertUltra). Since Xpert and XpertUltra were found diagnostically comparable in a subset of these data [@donovan2020], they were combined and denoted as Xpert. If CSF was repeatedly sampled (performed based on clinical need), only the first sample with at least 3mls of CSF collected, not later than the first week since admission, were used. Methods of CSF processing have been described elsewhere [@nhu2013, @donovan2020]. Briefly: CSF samples were centrifuged at 3000g for 15 minutes, and most of the CSF supernatant was removed. The CSF deposit was resuspended in 500µL of remaining supernatant, with this resuspended pellet then used for ZN smear (100µL), MGIT (200µL), and either Xpert or XpertUltra (200 µL). Laboratory tests for differential diagnoses routinely used were Gram stain for other bacterial meningitis, eosinophilic cell count in the CSF as an indicator for eosinophilic meningitis, Indian-ink stain or CSF lateral flow antigen providing confirmatory evidence for Cryptococcal meningitis. 

All patients with confirmed or suspected TBM received 4-drug anti-TB chemotherapy regimens according to national and local treatment guidelines. At the time of discharge or death, all patients received a final diagnosis. If at least one of ZN Smear, Xpert, or MGIT was positive from CSF at any time during the follow-up, the patient was considered to have confirmed TBM. Otherwise, if TBM was clinically suspected and treated, with confirmatory microbiological and molecular tests negative, the patient was considered to have suspected TBM. If the patient recovered without anti-TB chemotherapy, or an alternative diagnosis was confirmed microbiologically, they were reassigned to another diagnosis (i.e. not TBM).

## Statistical analysis

We conducted a Bayesian Latent Class Analysis (LCA) in which the three TBM confirmatory tests (ZN Smear, MGIT, and Xpert) were used as manifest variables. LCA is common in social science and psychology to detect different hidden traits [@Weller2020]. Recently, it has been adopted in several diagnostic studies, especially in Pulmonary Tuberculosis (PTB) and TBM[@schumacher2016; @stout2018; @lahuerta-marin2018; @adams2019]. As all tests are different methods to detect bacteria existence in samples under similar principle: direct visualisation (ZN Smear), DNA detection (Xpert), and culture growth (MGIT), our latent class was defined as the actual disease status (TBM or not TBM). Predictors for the latent class were chosen according to prior knowledge [@marais2010]. We added three differential diagnosis indicators: (1) CSF eosinophil count - a strong bio-marker for eosinophilic meningitis, a relatively common condition in Vietnam, usually caused by *Angiostrongylus cantonensis*; (2) CSF lateral flow antigen/Indian Ink tests for cryptococcal meningitis; and (3) CSF Gram stain for non-acid-fast bacterial meningitis. Also added was CSF red cell count whose high numbers being a marker of traumatic lumbar puncture requiring corrections to white cell counts and biochemical features [@greenberg2008; @nigrovic2011; @mehl1986]. Details of the model design are provided in the supplementary document.

```{r predictor-tab, eval=FALSE, tab.id="predictor-tab", include=FALSE, label='tab0', out.width="100%", tab.cap="Anticipated contribution of demographic and clinical features to the likelihood of TBM and CSF mycobacterial burden based on prior knowledge. Cell values are the expected direction of association and level of confidence; empty cells mean no association assumed"}
tibble::tribble(
  ~ 'Predictor'                    , ~ 'TBM prevalence', ~ 'Bacillary Burden',
  'Age'                            , '+, weak'  , ''                  ,
  'HIV infection'                  , '+, strong', '+, strong'         ,
  'Past TB contact'                , '+, weak'  , ''                  ,
  'TB-suggested symptoms'          , '+, weak'  , ''                  ,
  'Local motor deficit'            , '+, weak'  , ''                  ,         
  'Cranial nerve palsy'            , '+, weak'  , ''                  ,
  'Days from onset'                , '+, weak'  , ''                  ,
  'PTB/X-Ray'                      , '+, weak'  , ''                  ,
  'MTB/X-Ray'                      , '+, strong', ''                  ,
  'Glasgow Coma Score'             , '-, weak'  , ''                  ,
  'Cryptococcus Antigen/Indian Ink', '-, strong', ''                  ,
  'Blood Glucose'                  , '-, weak'  , ''                  ,
  'CSF Glucose'                    , '-, weak'  , '?, weak'     ,
  'CSF Lymphocyte Count'           , '+, weak'  , '-, weak'    ,
  'CSF Total While cell Count'     , '+-^[Risk of TBM peaks with intermediate CSF white cell count], weak' , '+, weak'    ,
  'CSF Protein'                    , '+, weak'  , '+, weak'    ,
  'CSF Lactate'                    , '+, weak'  , '+, weak'    ,
  'CSF Eosinophil Count'           , '-, strong', ''                  ,
  'CSF RBC Count'                  , '?, weak'   , ''                 
) |>
  flextable::flextable() |>
  ftExtra::colformat_md(2) |>
  # flextable::footnote(i=16, j=2, 
    # value=flextable::as_paragraph('')) |>
  flextable::width(j=1, width=2) |>
  flextable::width(j=2:3, width=1.2) |>
  flextable::theme_zebra() |>
  flextable::bold(bold = FALSE, part = "footer") |>
  flextable::italic(italic = TRUE, part = "footer" )
```

```{aligned_formula eval=FALSE, fml.lab='eq:fml-gcs', include=FALSE, results='asis'}
\begin{aligned}
RGCS &= 15 - GCS \\
RGCS_{Eyes} &= 4 - GCS_{Eyes} \\
RGCS_{Verbal} &= 5 - GCS_{Verbal} \\
RGCS_{Motor} &= 6 - GCS_{Motor}
\end{aligned}
```


<!-- Glasgow Coma Score (GCS) and Glasgow Coma Scale components (Voice - GCSV, Eyes - GCSE, and Muscle - GCSM) were translated to *Reversed GCS* as demonstrated in formula `r my_fn$labEq.docx('fml-gcs')`, so that a GCS of 15 is equal to a RGCS of 0 and a GCS of 3 is equal to RGCS of 12. Binary variables were dummy-coded into 0 for "Negative"/"No" and 1 for "Positive"/"Yes". -->

```{r gcs-tab, eval=FALSE, include=FALSE, out.width='100%', tab.cap='Conversion table from clasic Glasgow Coma Score (GCS) to Reversed GCS (RGCS)', tab.id='gcs-tab'}

tibble::tribble(
  ~ Feature,                     ~ Response, ~ GCS, ~ RGCS,
  'Eye response',        'Open sponatenously', 4, 0,
  'Eye response',     'Open to voice command', 3, 1,
  'Eye response',              'Open to pain', 2, 2,
  'Eye response',               'No eye open', 1, 3,
  'Verbal response',             'Orientated', 5, 0,
  'Verbal response',               'Confused', 4, 1,
  'Verbal response',     'Inappopriate words', 3, 2,
  'Verbal response','Incomprehensible sounds', 2, 3,
  'Verbal response',     'No verbal response', 1, 4,
  'Motor response',            'Obey command', 6, 0,
  'Motor response',         'Localising pain', 5, 1,
  'Motor response',    'Withdrawal from pain', 4, 2,
  'Motor response',                 'Flexing', 3, 3,
  'Motor response',               'Extending', 2, 4,
  'Motor response',       'No motor response', 1, 5
) |>
  flextable::flextable() |>
  flextable::merge_v(j = 1) |>  
  flextable::width(j=1, width=2) |>
  flextable::width(j=2, width=2)
```

```{r model-archs, eval=FALSE, include=FALSE, tab.cap="Model architectures and extensions", tab.id="model-archs"}
model_archs <-
  data.frame(
    Model=1:5,
    Def=c(
      'No bacillary burden; everyone in the same class has equal risk of tested positive',
      'Added individual bacillary burden; impacts of bacillary burden on test results are the same',
      'Impacts of bacillary burden are different for different tests',
      'Added technical fluctuation as a second random effect; fixed effects only contributes to bacillary burden',
      'Added fixed effects for technical fluctuation'
    )
  ) 

model_archs |> 
  flextable::flextable() |>
  flextable::set_header_labels(
    Model='Model', 
    Def='Base definition (Only added effects compared to lower number are mentioned)'
  ) |>
  flextable::width(j=1, width=.5)|>
  flextable::width(j=2, width=5) |>
  flextable::theme_zebra()
```

The basic design of our model is shown in figure \@ref(fig:skeleton-model) and in supplementary document. In brief, this consisted of one logistic regression estimating the prevalence of TBM in the population (prevalence model), a LCA estimating test sensitivity and specificity from that prevalence, and a linear regression estimating the latent bacillary burden among TBM positive patients (bacillary burden model), which added valued to the test results. All variables were scale-matched using Gelman's method [@gelman2008]. Weakly informative prior distributions were used for all coefficients. For TBM confirmatory test sensitivity and specificity, sufficient prior distributions capturing past estimates from earlier studies involving Vietnamese cohorts [@thwaites2004; @nhu2013; @heemskerk2018] were used. 

Using estimates from the model, we analysed *(1)* a simplified logistic regression against the latent TBM status that excluded laboratory information <!-- and added two clinical covariates (headache and psychosis) --> and *(2)* a mixed effect model approximating TBM risk after confirmatory tests. <!--This quantification is derivable mathematically but the formula is complicated.--> Because any positive test means definite TBM and MGIT is usually the most delayed test, we limited to five scenarios where different sets of confirmatory test were available and negative at diagnosis: _(a)_ only ZN Smear, _(b)_ only Xpert, _(c)_ ZN Smear and MGIT, _(d)_ ZN Smear and Xpert, and _(e)_ all there tests. 

By protocol, three TBM tests were missing if patients were not suspected. However, as these tests are known to have high specificity [@nhu2013, @heemskerk2018], we assumed that they were all negative. These assumptions will be tested by sensitivity analyses (supplementary document). Missing predictors were handled case by case basing on their expected missing mechanisms (supplementary document). Note that compared to the uniform case definition, we also made a change to *Past TB contact* to "*noticeable* contact with TB patients within the past year so all missing answer could be interpreted as "No". 

Several model complexity were considered [@schumacher2016]. Expected log point-wise predictive density (elpd) [@vehtari2016] was calculated from 5 repeated 20-fold cross validations and model maximising the metric were selected. Convergence were evaluated by Brooks-Gelman-Rubin statistic [@stan-doc]. We visualise calibration curves [@rms; @VanCalster2019], receiver operating characteristic (ROC) curves and area under the curve (AUC) to demonstrate the prediction accuracy and discrimination value. Best cut point for ROC was chosen by Youden's Index. <!--We also used the hospital diagnosis as a pseudo-gold standard to visualise the correlation of our model-based prediction and the standard approach.--> All analyses were performed on statistical package R, version 4.1.1 [@rcoreteam]. Posterior estimations were obtained via Hamiltonian Markov Chain Monte Carlo with 8000 effective iterations x 4 chains, using RStan package, version 2.27 [@stan-doc; @stan]. All code were published on [project's github repo](github.com/TBM-LCA).

```{r skeleton-model, fig.show='hold', out.width="100%", fig.align="center", fig.cap="Model basic design: TBM risk factors predict individuals' TBM statuses. TBM statuses are linked with test results. Bacillary burden additional modifies the probability of postive tests. Test positive probabilities are for demonstration only and do not correspond to the real ones.", fig.id='skeleton-model'}

fig_svg <- cowplot::ggdraw() + 
  cowplot::draw_image(magick::image_read_svg("includes/classicLCA.svg", width=212*5, height=159*5))
plot(fig_svg)
```

```{r mv-priors, eval=FALSE, fig.align='center', fig.cap="Density plots for prior distributions and their adherence to prior knowledge of sensitivity and specificity for TBM confirmation tests against then-made clinical diagnosis. Note that Thwaites 2004 was descriptive only while ZN and Culture in Nhu 2013 were references hence no Confidence Interval", fig.height=8, fig.id="mv-priors", warning=FALSE, dpi=300, include=FALSE, out.width='90%'}
sen_tbl <-
  tibble::tibble(
    'Test' = rep(c('ZN', 'Culture', 'Xpert'), 3),
    'Study' = rep(c('Thwaites 2004', 'Nhu 2013', 'Heemskerk 2018'), each=3),
    'est' = c(58/100, 64/100, NA, 78.64/100, 66.54/100, 59.34/100, 34.54/100, 31.84/100, 25.14/100),
    'lower.ci' = c(NA, NA, NA, 71.94/100, 59.14/100, 51.84/100, 29.94/100, 27.34/100, 21.04/100),
    'upper.ci' = c(NA, NA, NA, 84.34/100, 73.34/100, 66.54/100, 39.44/100, 36.74/100, 29.74/100)
  )

spc_tbl <-
  tibble::tibble(
    'Test' = rep(c('ZN', 'Culture', 'Xpert'), 3),
    # Test_id = rep(c(3,1,2), 2),
    'Study' = rep(c('Thwaites 2004','Nhu 2013', 'Heemskerk 2018'), each=3),
    'est' = c(NA, NA, NA, 0, 0, 0.05/100, 0, 0, 0),
    'upper.ci' = c(NA, NA, NA, NA, NA, (100-97.2)/100, (100-97.1)/100, (100-96.9)/100, (100-96.1)/100),
    'lower.ci' = c(NA, NA, NA, NA, NA, 0, 0, 0, 0)
  )

spc_rng = rbind(
  data.frame(
    Test = 'ZN',
    Test_id = 1,
    logit = rlogis(1000000,qlogis(.001),1.1),
    linear = rlogis(1000000,qlogis(.001),1.1) |> plogis()
  ),
  data.frame(
    Test = 'Culture',
    Test_id = 2,
    logit = rlogis(1000000,qlogis(.001),1.1),
    linear = rlogis(1000000,qlogis(.001),1.1) |> plogis()
  ),
  data.frame(
    Test = 'Xpert',
    Test_id = 3,
    logit = rlogis(1000000,qlogis(.005),.7),
    linear = rlogis(1000000,qlogis(.005),.7) |> plogis()
  )
) |>
  filter(linear<.1)
  

sen_rng = rbind(
  data.frame(
    Test = 'ZN',
    Test_id = 1,
    logit = rlogis(500000, 0,.3),
    linear = rlogis(500000, 0,.3) |> plogis()
  ),
  data.frame(
    Test = 'Culture',
    Test_id = 2,
     logit = rlogis(500000, 0,.3),
    linear = rlogis(500000, 0,.3) |> plogis()
  ),
  data.frame(
    Test = 'Xpert',
    Test_id = 3,
    logit = rlogis(500000, 0,.3),
    linear = rlogis(500000, 0,.3) |> plogis()
  )
) 

spc_linear_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=linear), data=spc_rng) +
  geom_point(aes(y= est, color = Study, x = -.2), data=spc_tbl, position=position_dodge(.2), shape=18, size=3) + 
  geom_linerange(aes(ymin = lower.ci, ymax = upper.ci, color = Study, x = -.2), data=spc_tbl, position=position_dodge(.2)) +
  coord_flip(ylim=c(0,.05))+
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  scale_color_discrete(drop=FALSE)+
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

spc_logit_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=logit), data=spc_rng) +
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  coord_flip(ylim=c(-15, 2.5)) +
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

sen_linear_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=linear), data=sen_rng) +
  geom_point(aes(y= est, color = Study, x = -.2), data=sen_tbl, position=position_dodge(.2), shape=18, size=3) + 
  geom_linerange(aes(ymin = lower.ci, ymax = upper.ci, color = Study, x = -.2), data=sen_tbl, position=position_dodge(.2)) +
  coord_flip()+
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

sen_logit_plt <- ggplot() + 
  ggdist::stat_halfeye(mapping=aes(y=logit), data=sen_rng) +
  facet_grid(Test~.)+
  xlab('') + ylab('') +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
  

plt <- (spc_linear_plt + ggtitle('FPR (1-Specificity)') + theme(legend.position = "none") | spc_logit_plt) /
  (sen_linear_plt + ggtitle('TPR (Sensitivity)') + theme(legend.position = "bottom") | sen_logit_plt) 

for (i in 1:2) plt[[i]] <- plt[[i]] + plot_layout(tag_level = 'new')
color_me <- list("#000000", "#E69F00", "#56B4E9", c("#000000", "#E69F00", "#56B4E9", "#009E73"))
withr::with_options(
  list(ggplot2.discrete.colour = color_me),

  plt + plot_annotation(tag_levels = list(c('',''), 'A'), caption='A: Linear scale, B: Logistic Scale \n Black dots, thick lines and thin lines are median, IQR, and 95% inter-percentile range') + plot_layout(guides = 'collect') & theme(text = element_text('serif', size = 9), plot.tag = element_text('serif', size = 9), legend.position = "bottom") 
)
```

<!--Since latent class analysis models unobserved characteristics, results may be strongly dependent on our assumptions. Therefore, we conducted sensitivity analyses where some assumptions were lifted or changed. We first increased the standard deviation of our prior for specificities of all confirmatory tests so that every value in the range of 90%-100% were accepted. We also changed the prior distributions of the parameters in the prevalence and bacillary burden models from *normal* to a more skeptical one *Student's t* with 4 degrees of freedom; means and scales, however, were kept as-is. Their *elpd*s were compared. Thirdly, as recent studies suggested a sup-optimal specificity of Xpert test on CSF samples [@nhu2013; @chen2020], we considered a Missing-At-Random scenario, where observation chance of confirmation tests depend on the unknown TBM status and locally independent to the value of confirmation tests. Observation status was then included in the model as a separated manifest variables. We visualised the estimates of this model with the best performing one in our main analysis.

Furthermore, to explore hidden effects, we added quadratic terms for all five CSF bio-markers and RGCS to the prevalence model; CSF volume was additionally included to capture its potential impact on test sensitivity. *Laplace* priors were utilised instead of *Normal* for all linear covariates. Posteriors and performance metrics of this model were reported.-->

<!-- All data preparation, cleaning, and processing were performed on statistical package R, version 4.1.1 [@rcoreteam]. Posterior distributions were obtained via Hamiltonian Markov Chain Monte Carlo with 8000 effective iterations in each of 4 chains, using RStan [@stan-doc] package, version 2.27 [@stan]. <!--. Plotting was done using package bayesplot [@bayesplot], classifierplots [@classifierplots], and ggvenn [@ggvenn]. Post-hoc linear mixed-effect model was fitted by package lme4 [@lme4]. -->


<!--chapter:end:03-Methods.Rmd-->

# Results

```{r calc_na}
suspected_hiv <- data_dirty |> filter(DISDIA %in% c('DIA1', 'DIA10', 'DIA12'))
n_test_suspected_hiv <- nrow(suspected_hiv) - na(suspected_hiv$hiv_stat)
```

## Clinical characteristics

From 29th August 2017 to 22nd January 2021, there were `r nrow(data_dirty)` patients with suspected brain infection enrolled into study. `r nrow(data_19EI)` were included in the analysis (figure \@ref(fig:patient-flow)). 

```{r echo=FALSE}
var = c()
var[1] <- nrow(data_dirty)
var[2] <- sum(is.na(data_dirty$wrong_name) | data_dirty$wrong_name, na.rm=TRUE)
var[3] <- data_dirty[, sum((wrong_name%in%F) & (Volume<3)%in%TRUE)]
var[4] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    (is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[5] <- with(data_dirty,sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    !(is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)), na.rm=T))
var[6] <- with(data_dirty, sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    csf_mgit_contaminated, na.rm=TRUE))
var[7] <- with(data_dirty,  sum(
  (wrong_name%in%F) &
    !((Volume<3)%in%TRUE) &
    !(csf_mgit_contaminated %in% T) &
    (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
    ((csf_smear%in%T)|(csf_mgit%in%T)|(csf_xpert%in%T)), na.rm=TRUE))
var[8] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      !(other_dis_dx_conf%in%T)&
      !((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
var[9] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE)  &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert)&
      (other_dis_dx_conf%in%T),
    na.rm=TRUE))
var[10] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) & 
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      is.na(csf_smear)&is.na(csf_mgit)&is.na(csf_xpert) &
      !(other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[11] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      (other_dis_dx_conf%in%T), 
    na.rm=TRUE))
var[12] <- with(data_dirty, sum(
    !((Volume<3)%in%TRUE) &
      (wrong_name%in%F) &
      !(csf_mgit_contaminated %in% T) &
      (!is.na(csf_smear)|!is.na(csf_mgit)|!is.na(csf_xpert))&
      (!(csf_smear%in%T)&!(csf_mgit%in%T)&!(csf_xpert%in%T)) & 
      # !(other_dis_dx_conf%in%T)&
      ((DISDIA=='DIA1')%in%TRUE),
    na.rm=TRUE))
```

Characteristics of analysed population are shown in table \@ref(tab:test-bl-tbl). There were no significant different in the age of different groups, with the mean of `r quantile(data_dirty$age, .5, na.rm=TRUE) |> round(1)`. HIV were tested for `r nrow(data_dirty) - na(data_dirty$hiv_stat)` (`r round((nrow(data_dirty) - na(data_dirty$hiv_stat))/nrow(data_dirty)*100, 0)`%) enrolled individuals.  <!-- As HIV was only tested for suspected patients who admitted with HIV-related conditions or involved in high-risk activities, we assumed the HIV rate for the untested group to be similar to that of the general population. Missing GCSV due to intubation is a common issue and the practice of using a model-based imputation approach is supported[@Teasdale2014], as all the Glasgow Coma Scale components are usually highly correlated.--> Both HIV prevalence and duration from symptom onset in the test positive groups were consistently higher than those in the test negative groups. Overall, there were `r var[5]` participants with valid TBM confirmatory tests, `r var[7]` were microbiology confirmed \@ref(fig:venn-test). `r var[11]` were later confirmed with another disease. In the untested group, `r var[9]` were microbiologically diagnosed with non-TBM conditions. There were `r var[8]+var[10]` patients were not confirmed with any infection.

```{diagrammer patient-flow, fig.show="hold", out.width="100%", out.height="10cm",  fig.align="center", fig.cap="Recruited patient profile", fig.id="patient-flow"}
digraph patientflow {
  # compound = true;
  graph[dpi = 300, fontname="CMU Serif", splines=line];
  node[fontname = "CMU Serif", shape='rectangle'];
  # edge[splines=line]
  
  Total [label = "@@1 enrolled and have CSF samples collected" ]
  
  subgraph exclude1{
    WrongName [label ="@@2 excluded due to mis-matched names"]
    LowVolume [label = "@@3 excluded due to low CSF volume collected"]
    Contaminated [label = "@@6 excluded due to contaminated culture"]
  }
  
  NotTested [label = "@@4 not tested for TBM"]
  Tested [label = "@@5 tested for TBM"]
  # {rank=same; WrongName; LowVolume}
  {rank=same; Tested; NotTested}
  
  TBM [label = "@@7 confirmed TBM\l\n@@12 suspected TBM\l\n@@11 confirmed other cause\l\n@@8 unconfirmed cause\l"]
  NotTBM [label = "@@9 confirmed other disease\l\n@@10 unconfirmed cause\l"]
  {rank=same; TBM; NotTBM};
  
  WrongName:s -> LowVolume:n[style=invis]
  LowVolume:s -> Contaminated:n[style=invis]
  LowVolume:e -> Tested:w[style=invis]
  Total:s -> WrongName:e
  Total:s -> LowVolume:e
  Total:s -> NotTested:n
  Total:s -> Tested:n
  NotTested:s -> NotTBM:n
  Tested:s -> TBM:n
  Tested:s -> Contaminated:e
  Contaminated:e -> TBM:w[style=invis]
  # Contaminated:s -> NotTBM:n[style=invis]
}
[1]: var[1]
[2]: var[2]
[3]: var[3]
[4]: var[4]
[5]: var[5]
[6]: var[6]
[7]: var[7]
[8]: var[8]
[9]: var[9]
[10]: var[10]
[11]: var[11]
[12]: var[12]
```

```{r venn-test, out.width='50%', fig.align='center', fig.asp=1, fig.cap = 'Venn diagram for ZN Smear, MGIT, and Xpert'}

data_19EI |>
  mutate(across(c(csf_smear, csf_mgit, csf_xpert), as.logical)) |>
  ggplot() +
  ggvenn::geom_venn(aes(A = csf_smear, B = csf_mgit, C = csf_xpert), 
                    fill_color = c('#E5707E', '#E6B566', '#A3DDCB'),
                    stroke_color = c('#E5707E', '#E6B566', '#A3DDCB'),
                    set_names = c('ZN Smear', 'MGIT', 'Xpert'),
                    text_size = 3, set_name_size = 4) +
  theme_void()

```

\newpage

\blandscape

<!---BLOCK_LANDSCAPE_START--->

```{r test-bl-tbl, echo=FALSE, tab.cap="Baseline characteristics of all study patients", tab.id="test-bl-tbl"}
bl_tbl <- 
  data_dirty |>
  as_tibble() |>
  mutate(csf_neutro = csf_wbc - csf_lympho - csf_eos) |>
  mutate(
    across(c(csf_smear, csf_xpert, csf_mgit), 
           ~ factor(.x, 
                    levels = c(TRUE, FALSE,NA), 
                    labels = c('Positive', 'Negative', 'Missing'),
                    exclude = NULL
           )
    )
  ) |>
  select(age, hiv_stat, clin_illness_day, clin_symptoms, clin_contact_tb, clin_motor_palsy, clin_nerve_palsy, clin_gcs, xray_pul_tb, xray_miliary_tb, csf_lympho, csf_wbc, csf_eos, csf_rbc, csf_protein, csf_lactate, csf_glucose, bld_glucose = BLDGLU, csf_crypto, csf_smear, csf_xpert, csf_mgit) |>
  tidyr::pivot_longer(
    c(csf_smear, csf_mgit, csf_xpert),
    names_to = 'Test',
    values_to = 'Result'
  ) |>
  my_fn$add_labels(
    age               = 'Age',
    hiv_stat          = 'HIV Positive', 
    clin_illness_day  = 'Symptom duration',
    clin_symptoms     = 'TB-suggested systemic symptoms',
    clin_contact_tb   = 'Past noticeable contact TB within 12 months',
    clin_motor_palsy  = 'Focal neurological deficit',
    clin_nerve_palsy  = 'Cranial nerve palsy',
    # GCSV              = 'Glasgow Coma Scale-Verbal',
    # GCSM              = 'Glasgow Coma Scale-Motor',
    # GCSE              = 'Glasgow Coma Scale-Eyes',
    clin_gcs          = 'Glasgow Coma Score',
    xray_pul_tb       = 'X-Ray Pulmonary TB (not Miliary TB)',
    xray_miliary_tb   = 'X-Ray Miliary TB',
    csf_lympho        = 'CSF Lymphocyte Count',
    csf_wbc           = 'CSF Total White cell Count',
    # csf_neutro        = 'CSF Neutrophil Count',
    csf_eos           = 'CSF Eosinophil Count',
    csf_rbc           = 'CSF Red blood cell Count',
    csf_protein       = 'CSF Protein',
    csf_lactate       = 'CSF Lactate',
    csf_glucose       = 'CSF Glucose',
    bld_glucose       = 'Corresponding Blood Glucose',
    csf_crypto        = 'Cryptococcal Antigen/Indian Ink'
  ) |>
  # mutate(- csf_neutro) |>
  mutate(
    Test = case_when(
      Test == 'csf_smear' ~ 'ZN Smear',
      Test == 'csf_mgit'  ~ 'MGIT',
      Test == 'csf_xpert' ~ 'Xpert (Ultra)',
    )
    # Result = ifelse(is.na(Result), 'Missing', Result) |> factor()
  ) |>
  tbl_strata(
    strata = Test,
    .tbl_fun = ~ tbl_summary(
      .x, 
      by = Result,
      missing_text = '  - Missing',
      # type = list(GCSV~'continuous', GCSE~'continuous',GCSM~'continuous'),
      statistic = list(
        all_continuous() ~ '{mean} ({p25}, {p75})'),
      digits = list(csf_eos ~ c(0, 0, 0), clin_gcs ~ c(0, 0, 0))
    )
  ) |>
  modify_footnote(
    update = all_stat_cols() ~ "Mean (1st, 3rd quartiles) for numeric variables; n (%) for categorical variables",
    text_interpret = "html"
  )

bl_tbl |> as_flex_table() |>
  # flextable::set_caption('Baseline characteristics') |>
  flextable::width(width = .88) |>
  flextable::fontsize(size=9, part = 'all') |>
  flextable::theme_vanilla()
```

<!---BLOCK_LANDSCAPE_STOP--->

\elandscape

\newpage

```{r missing-handling,eval=FALSE, include=FALSE, tab.cap="Rationales and measures to handle missing values", tab.id="missing-handling"}
na = \(x) sum(is.na(x))
data_dirty$csf_neutro <- data_dirty$NEUPER * data_dirty$csf_wbc / 100
data_dirty %$%
  tibble::tribble(
     ~ 'Variable'           , ~ 'N\n missing'     ,  ~ 'Expected Reason of Missingness'                      , ~ 'Mechanism',        ~ 'Handling method' ,
    'ZN Smear'              , na(csf_smear)       , 'Not suspected TBM'                                      , 'MNAR'               , 'Set = 0'          , 
    'MGIT'                  , na(csf_mgit)        , 'Not suspected TBM'                                      , 'MNAR'               , 'Set = 0'          , 
    'Xpert'                 , na(csf_xpert)       , 'Not suspected TBM'                                      , 'MNAR'               , 'Set = 0'          , 
    'HIV Status'            , na(hiv_stat)        , 'Not suspeted HIV'                                     , 'MNAR'           , 'Impute by population prevalence'       ,
    'TB-systemic symptoms' , na(clin_symptoms)   , 'Unmeasured / Unnoticed / Unconscious'                   , 'MAR'           , 'Imputation'       ,
    'Local neuro-deficit'   , na(clin_motor_palsy), 'Unconscious'                                            , 'MAR/MNAR'           , 'Imputation'       ,
    'Glasgow Coma Score'    , na(clin_gcs)        , 'Intubated / Forgot'       , 'MAR'                , 'Imputation'       ,
    'Age'                   , na(age)             , 'Input error'                                            , 'MCAR'              , 'Imputation'       ,
    'Illness days'          , na(clin_illness_day), 'Patients forget / Unconscious'                          , 'MAR'                , 'Imputation'       ,
    'Blood Lymphocyte'      , na(LYMP)            , 'Unmeasured (premature death)'                           , 'MAR'                , 'Imputation'       ,
    'Blood Neutrophil'      , na(NEUTRO)          , 'Unmeasured (premature death)'                           , 'MAR'                , 'Imputation'       ,
    'Blood Glucose'         , na(BLDGLU)          , 'Most likely input error / Unmeasured (premature death)', 'MAR/MCAR'           , 'Imputation'       ,
    'CSF glucose'           , na(csf_glucose)     , 'Unmeasured (premature death)'                           , 'MAR/MCAR'           , 'Imputation'       ,
    'CSF lymphocyte count'  , na(csf_lympho)      , 'Very low or zero / Input error / Unmeasured (premature death)', 'MNAR/MAR'           , 'Manually set/Imputation',
    'CSF neutrophil count'  , na(csf_neutro)      , 'Very low or zero / Input error / Unmeasured (premature death)', 'MNAR/MAR'           , 'Manually set/Imputation',
    'CSF protein'           , na(csf_protein)     , 'Data input error / Test error'       , 'MAR/MCAR'           , 'Imputation'       ,
    'CSF lactate'           , na(csf_lactate)     , 'Data input error / Test error'                              , 'MAR/MCAR'           , 'Imputation'     
    # 'CSF RBC count'         , na(csf_rbc)         , 'Zero cell count'                                        , 'MNAR'               , 'Set = 0'                  
  ) |>
  flextable::flextable() |>
  # flextable::set_caption('Rationale and method of missing values handling') |>
  flextable::width(width = 1.25) |>
  flextable::footnote(i = c(14,15),j = 1,inline=FALSE,
                      value=flextable::as_paragraph(rep('CSF Cell counts = CSF white-cell count x Pct of Cell Type / 100; if very low, then either lymphocytes or neutrophils had values, the other were left missing')),
                      part = 'body') |>
  flextable::footnote(i = c(1),j = 1,inline=FALSE,
                      value=flextable::as_paragraph(rep('GCS Verbal is assumed to be MAR after correction for the other two, and is predicted by a model-based imputation[@Teasdale2014]')),
                      part = 'body') |>
  flextable::merge_v(part='footer') |>
  flextable::theme_vanilla() |>
  flextable::bold(bold=FALSE, part='footer') |>
  flextable::italic(italic=TRUE, part='footer')
```

## Model estimation

```{r est_fun, include=FALSE}
est = \(name, tab, digits=2, transformation = I, ci.sep = ', ', post.fn = I, pre.fn=I) {
  m <- c(pre.fn(tab[name, 'mean']), pre.fn(tab[name, '2.5%']), pre.fn(tab[name, '97.5%'])) |> transformation() 
  c(m[1]|> formatC(digits=digits, format='f') |> post.fn(),
    # m[2]|> formatC(digits=digits, format='f') |> post.fn(), 
    paste(min(m[2:3]) |> formatC(digits=digits, format='f') |> post.fn(), 
          max(m[2:3]) |> formatC(digits=digits, format='f') |> post.fn(), sep=ci.sep))
}

spc.est = purrr::partial(est,
                         transformation=\(x) 100*(1-x), ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))
sen.est = purrr::partial(est, transformation=\(x) 100*x, ci.sep=' - ', digits=1,
                         post.fn = \(x) paste0(x, '%'))

spc.est2 = purrr::partial(est,
                         transformation=\(x) (1-x), ci.sep=', ', digits=2)
sen.est2 = purrr::partial(est, ci.sep=', ', digits=2)

sen = \(name, hiv=NULL, fn=sen.est) {
  name = paste0(name, '[2]')
  do.call(sprintf, as.list(c('%s (%s)', fn(name, 
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
}

spc = \(name, hiv=NULL, fn=spc.est) {
  name = paste0(name, '[1]')
  do.call(sprintf, as.list(c('%s (%s)', fn(name,
                                                tab = if (!length(hiv)) p_summary else if(hiv) p_hiv_pos_summary else p_hiv_neg_summary))))
}
```

Posterior estimates for ZN Smear, MGIT, and Xpert performances against latent TBM status are reported in table \@ref(tab:mv-posterior). All confirmatory assays had over 99% specificity. Smear was the most sensitive test with `r sen('z_Smear', hiv=FALSE)` for HIV negative patients and `r sen('z_Smear', hiv=TRUE)` for HIV positive patients. Xpert was least sensitive, especially amongst HIV negative population, with only `r sen('z_Xpert', hiv=FALSE)`, but was significantly higher and comparable to that of culturing in HIV positive group: `r sen('z_Xpert', hiv=TRUE)`.

Estimated coefficients for TB risk factors are shown in figure \@ref(fig:coef-est). Patients with HIV, Miliary TB, long symptom duration, and past TBM contacts were in the higher risk group of TBM. Of the laboratory variables, increased TBM risk were associated with low CSF glucose, low paired Blood Glucose, and high CSF lymphocyte count. CSF protein and lactate showed minimal trends of positive association. Total white blood cells showed quadratic trends with peaked TBM risk at intermediate values.

Amongst the included bacillary burden impacting factors, HIV and higher CSF protein were both associated with higher burden, with glucose stood on the opposite side. Although higher lymphocyte count in CSF sample means a higher chance of TBM compared with other diagnoses, it was associated with a reduction in the expected mycobacterial burden, presumably a reduction of confirmatory test detection rates.

```{r mv-posterior, tab.cap="Posterior estimates of test sensitivities and specificities, for overall population, and stratified by HIV", tab.id="mv-posterior"}
pr_neg <- matrix(c(
  c('Test', rep(c('Specificity'),1), rep(c('Sensitivity'),1)),
  # c('Test', rep(c('Estimates'),2)),
  c('Smear',
    # est('z_Smear[1]', tab = p_hiv_neg_summary,  transformation =\(x) 1-(x)), 
    # est('z_Smear[2]', tab = p_hiv_neg_summary)),
    spc("z_Smear", hiv=FALSE, fn=spc.est2),
    sen("z_Smear", hiv=FALSE, fn=sen.est2)),
  c('Mgit',
    # est('z_Mgit[1]', tab = p_hiv_neg_summary, transformation =\(x) 1-(x)), 
    # est('z_Mgit[2]', tab = p_hiv_neg_summary)),
    spc("z_Mgit", hiv=FALSE, fn=spc.est2),
    sen("z_Mgit", hiv=FALSE, fn=sen.est2)),
  c('Xpert',
    # est('z_Xpert[1]', tab = p_hiv_neg_summary, transformation =\(x) 1-(x)), 
    # est('z_Xpert[2]', tab = p_hiv_neg_summary))
    spc("z_Xpert", hiv=FALSE, fn=spc.est2),
    sen("z_Xpert", hiv=FALSE, fn=sen.est2))
), byrow=T, nrow=4)

pr_pos <- matrix(c(
  c('Test', rep(c('Specificity'),1), rep(c('Sensitivity'),1)),
  # c('Test', rep(c('Estimates'),2)),
  c('Smear',
    spc("z_Smear", hiv=TRUE, fn=spc.est2),
    sen("z_Smear", hiv=TRUE, fn=sen.est2)),
  c('Mgit',
    # est('z_Mgit[1]', tab = p_hiv_pos_summary, transformation =\(x) 1-(x)), 
    # est('z_Mgit[2]', tab = p_hiv_pos_summary)),
    spc("z_Mgit", hiv=TRUE, fn=spc.est2),
    sen("z_Mgit", hiv=TRUE, fn=sen.est2)),
  c('Xpert',
    # est('z_Xpert[1]', tab = p_hiv_pos_summary, transformation =\(x) 1-(x)), 
    # est('z_Xpert[2]', tab = p_hiv_pos_summary))
    spc("z_Xpert", hiv=TRUE, fn=spc.est2),
    sen("z_Xpert", hiv=TRUE, fn=sen.est2))
), byrow=T, nrow=4)

pr <- matrix(c(
  c('Test', rep(c('Specificity'),1), rep(c('Sensitivity'),1)),
  # c('Test', rep(c('Estimates'),2)),
  c('Smear',
    # est('z_Smear[1]', tab = p_summary,  transformation =\(x) 1-(x)), 
    # est('z_Smear[2]', tab = p_summary)),
    spc("z_Smear", hiv=NULL, fn=spc.est2),
    sen("z_Smear", hiv=NULL, fn=sen.est2)),
  c('Mgit',
    # est('z_Mgit[1]', tab = p_summary, transformation =\(x) 1-(x)), 
    # est('z_Mgit[2]', tab = p_summary)),
    spc("z_Mgit", hiv=NULL, fn=spc.est2),
    sen("z_Mgit", hiv=NULL, fn=sen.est2)),
  c('Xpert',
    # est('z_Xpert[1]', tab = p_summary, transformation =\(x) 1-(x)), 
    # est('z_Xpert[2]', tab = p_summary))
    spc("z_Xpert", hiv=NULL, fn=spc.est2),
    sen("z_Xpert", hiv=NULL, fn=sen.est2))
), byrow=T, nrow=4)

huxtable::as_hux(cbind(pr, pr_neg[,-1], pr_pos[,-1])) |>
  huxtable::as_flextable() |>
  flextable::add_header_row(values=c("", rep("Overall",2), rep("HIV (-)",2), rep("HIV (+)",2))) |>
  # flextable::merge_h(i=1, part='body') |>
  flextable::merge_h(i=1, part='header') |>
  flextable::width(width = 1) |>
  flextable::bold(i=1) |>
  flextable::theme_vanilla() |>
  flextable::align(i=1, align='center') |>
  flextable::align(i=1, align='center', part='header') |>
  flextable::add_footer_row(top=F, values="Values are in the form Mean (95% Credible interval)", colwidths = 7)
```

```{r coef-est, out.width='100%', fig.align='center', fig.asp=1.4, fig.cap = 'Posterior estimaties or coefficients of TBM risk factors and bacillary burden impacting variables, on matched and original scales. Points, thick lines, and thin lines are posterior means, 50\\% and 95\\% credible intervals'}
(a_plot + ggtitle('TBM Risk factor')) /
  (b_plot + ggtitle('Bacillary burden predictors')) + 
  plot_layout(nrow=2, heights=c(7,2))&
  theme(text = element_text('serif', size = 9), plot.tag = element_text('serif', size = 9), axis.text.y = ggtext::element_markdown(family=NULL, face='bold'), legend.position = "right") 
```

## Model validation 

Selected model showed good discrimination with cross-validated AUCs of `r classifierplots:::calculate_auc(test.y = data_19EI$csf_smear, pred.prob = m3$p$p_Smear$mean) |> round(0)`% for ZN Smear, `r classifierplots:::calculate_auc(test.y = data_19EI$csf_mgit, pred.prob = m3$p$p_Mgit$mean) |> round(0)`% for culturing, and  `r classifierplots:::calculate_auc(test.y = data_19EI$csf_xpert, pred.prob = m3$p$p_Xpert$mean) |> round(0)`% for Xpert (figure \@ref(fig:best-metrics)). The model was decently calibrated, estimated probabilities and observed frequency of test positive showed overall agreement [@VanCalster2019], with slight drop at the upper tail of for MGIT culturing and Xpert. The AUC for TBM prediction against hospital diagnosis were  `r classifierplots:::calculate_auc(test.y = !data_19EI$other_dis_dx, pred.prob = m3$p$theta$mean) |> round(2)`% and calibration plots show over-estimation at the centre (figure \@ref(fig:theta-metrics)). 

```{r best-metrics, fig.align='center', fig.cap='ROC curves (upper half) and calibration plots (lower half) for the selected model, against observed test results. Results from individual CV repetitions are shown in fainted grey and the average curves are in colour.', fig.dim=c(8,6), dpi=600, message=FALSE, warning=FALSE, out.width='90%'}
m3_roc = readRDS(file.path(data_dir, '..', 'export', 'm3_roc.RDS')) 
m3_calib = readRDS(file.path(data_dir, '..', 'export', 'm3_calib.RDS')) 
w = wrap_plots(m3_roc$Y, m3_calib$Y, ncol=1, heights=c(1,1))
plot(w)
```

```{r theta-metrics-prep, include=FALSE}
theta_rocs <- m3_roc$C + ggtitle('Hospital Diagnosis') + theme_bw()
theta_calib <- m3_calib$C
```

```{r theta-metrics, fig.align='center', fig.cap='ROC curves and calibration plots for selected model againts discharge diagnosis. Results from individual CV repetitions are shown in fainted grey and the average curves are in colour.', fig.dim=c(10,5), dpi=600, message=FALSE, warning=FALSE, out.width='100%'}
theta_rocs+theta_calib
```
## Changes of TBM risk Post confirmatory test negative

```{r load-fit, include=FALSE}
post_test = list()
post_test$fit <- readRDS(file.path(data_dir, '..', 'export', 'post_test.RDS'))$fit2
post_test$est <- coef(summary(post_test$fit))[, 'Estimate']
post_test$confint <- confint(post_test$fit)

post_test$get_est <- function(name, hiv = FALSE, inv=FALSE){
  if (inv){ 
    f = \(x) -x
    first = "97.5 %"
    second = "2.5 %"
  } else {
    f = \(x) x
    first = "2.5 %"
    second = "97.5 %"
  }
  name = paste0("time", name, "_neg")
  if (!hiv) return (glue::glue("{round(2^f(post_test$est[name]),2)} ({round(2^f(post_test$confint[name, first]),2)}, {round(2^f(post_test$confint[name,second]),2)})"))
  name2 = paste0(name,":hivTRUE")
  glue::glue("{round(2^f(post_test$est[name]+post_test$est[name2]),2)} ({round(2^f(post_test$confint[name,first]+post_test$confint[name2,first]),2)} -  {round(2^f(post_test$confint[name,second]+post_test$confint[name2,second]),2)})")
}
# post_test_tbl <- data.frame(Scenario = NULL, HIV_neg = NULL, HIV_postivive=NULL)
post_test_tbl = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-', '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-', '-'),
    HIV_neg = c(post_test$get_est("smear"),
                post_test$get_est("xpert"), 
                post_test$get_est("smear_mgit"), 
                post_test$get_est("smear_xpert"),
                # post_test$get_est("mgit_xpert"),
                post_test$get_est("all")
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE),
                post_test$get_est("xpert", hiv=TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE),
                post_test$get_est("all", hiv=TRUE))
  )

post_test_tbl_inv = data.frame(
    Scenario = letters[1:5],
    Smear = c('-', '?', '-', '-',  '-'),
    MGIT = c('?', '?', '-', '?', '-'),
    Xpert = c('?', '-', '?', '-','-'),
    # Scenario = c("Smear (-)", "Xpert (-)", 
    #              "Smear & MGIT (-)", "Smear & Xpert (-)", "Xpert & MGIT (-)",
    #              "All tests (-)"),
    HIV_neg = c(post_test$get_est("smear", inv = TRUE),
                post_test$get_est("xpert", inv = TRUE), 
                post_test$get_est("smear_mgit", inv = TRUE), 
                post_test$get_est("smear_xpert", inv = TRUE),
                # post_test$get_est("mgit_xpert", inv = TRUE),
                post_test$get_est("all", inv = TRUE)
                ),
    HIV_pos = c(post_test$get_est("smear", hiv=TRUE, inv = TRUE),
                post_test$get_est("xpert", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_mgit", hiv=TRUE, inv = TRUE), 
                post_test$get_est("smear_xpert", hiv=TRUE, inv = TRUE), 
                # post_test$get_est("mgit_xpert", hiv=TRUE, inv = TRUE),
                post_test$get_est("all", hiv=TRUE, inv = TRUE))
  )
```
 
<!--Figure \@ref(fig:fit-post-test-change) demonstrates TBM probability in our population given a chronological scenario where ZN Smear, Xpert, and MGIT culture results sequentially returned negative over time. --> Change in TBM probability relative to pre-test values are shown in table \@ref(tab:tbl-post-test). Briefly, a negative Smear only was associated with `r post_test_tbl_inv$HIV_neg[1]`-fold reduction in TBM. Combined negative Smear and either MGIT or Xpert was associated with 2.9-time decrease of TBM risk for HIV negative and 4-time for HIV positive population. With all tests negative, the TBM probability reduced by `r post_test_tbl_inv$HIV_neg[5]` and `r post_test_tbl_inv$HIV_pos[5]` for HIV negative and postive respectively. 

```{r tbl-post-test, tab.cap="Average changes in TBM probability given available test result(s), relative to pre-confirmatory test TBM probability. Assume pre-test risk is 1, the values measure post-test risk in each scenario", tab.id = "tbl-post-test"}
flextable::flextable(post_test_tbl) |> 
  flextable::set_header_labels(values=list(Scenario="Scenario", HIV_neg="HIV (-)", HIV_pos="HIV (+)")) |>
  flextable::bold(j= 1) |>
  flextable::width(width = c(1, 0.7, 0.7, 0.7, 1.5, 1.5)) |>
  flextable::theme_vanilla() |>
  flextable::align(i=1, part='header', align='center') |>
  flextable::align(j=1:4, part='body', align='center') |>
  flextable::add_footer_row(top=F, values="Values are in the form Mean (95% Credible interval)", colwidths = 6)
```

\newpage

```{r fit-post-test-change, fig.align='center', fig.cap='Changes in TBM risk over time in a hypothetical scenario when ZN Smear, Xpert, and MGIT culturing sequentially returned negative', fig.dim=c(10,5), dpi=600, message=FALSE, warning=FALSE, include=F, eval=F}
post_test$data = post_test$fit@frame |>
  filter(
    time %in% c("no_test", "smear_neg", "smear_xpert_neg", "all_neg")
  ) %>%
  mutate(
    time = factor(time, levels = c("no_test", "smear_neg", "smear_xpert_neg", "all_neg")),
    value = 2^`log2(value)`
  )

ggplot(data=post_test$data, aes(x = time, y = value, color=hiv)) + 
  geom_boxplot() + 
  scale_x_discrete(label = c("Pre-test", "Smear returned (-)", "Smear & Xpert returned (-)", "All returned (-)"), name="Timeline") +
  scale_y_continuous(breaks = seq(0,1,.25), labels = paste(seq(0,1,.25)*100, '%'), name = "TBM probability") +
  scale_color_discrete(name="HIV status", labels = c("Negative", "Positive")) + 
  theme_bw()
```

## Simplified model

In the simplified model, HIV+ and symptom duration from onset were associated with a TBM diagnosis (figure \@ref(fig:simplified-model-plot)). Local neurological deficit and cranial nerve palsy, without the existence of laboratorial tests, both showed as positive risk factors, similarly to two additional signs (headache and psychosis). Our simplified model had good AUC against held-out hospital diagnosis. The best cut-point maximising Youden's index of 30.4% had sensitivity of 76.7% and specificity of 79.1%. Based on the cut-point provided a simplified scoring system for an easy estimation of TBM risk at admission.


```{r simplified-model-plot, fig.align='center', fig.cap='Left: Posterior estimates of coefficients of clinical TBM risk factors. Points, thick lines, and thin lines are posterior means, 50\\% and 95\\% credible intervals. Right: ROC curves (upper half) and calibration plots (lower half) for the selected model, against observed test results. Results from individual CV repetitions are shown in fainted grey and the average curves are in colour', message=FALSE, warning=FALSE, out.width='100%', dpi=600, fig.dim=c(8, 6), fig.id = "simplified-model-plot"}
# tmp_svg <- cowplot::ggdraw() + 
#   cowplot::draw_image(magick::image_read_svg("includes/a_plog_s.svg", width=212*5, height=159*5))
# plot(tmp_svg)
a_plot_s <- readRDS(file.path(data_dir, '..', 'export', 'a_plot_s.RDS')) + theme(text = element_text('serif', size = 9), plot.tag = element_text('serif', size = 9), axis.text.y = ggtext::element_markdown(family=NULL, face='bold'), legend.position = "none") 
metrics_s <- readRDS(file.path(data_dir, '..', 'export', 'metrics', 's1_plots.RDS')) 

plot(a_plot_s + ((metrics_s$calib + ggtitle("Hospital Diagnosis"))/ (metrics_s$roc + ggtitle(''))))
```

```{r score-table, tab.cap="Simplified scoring table", tab.id = "score-table"}
m = data.frame(
  Criterion = c(
    'HIV +',
    'TB-suggested symptoms',
    'Local neurological deficit',
    'Cranial nerve palsy',
    'Past noticed TB contact',
    'Glasgow coma score',
    'Pulmonary TB/X-ray',
    'Miliary TB/X-Ray',
    'Days from onset',
    'Headache',
    'Pyschosis'),
  Estimate = a_plot_s$data |> filter(parameter %in% paste0('a[',c(1:5, 9, 6:8, 10:11),']')) %>% .$m %>% round(2),
  Score = c(2, -0.5, 0, 0.5, 0.5, "GCS/2",  2, 0.5, "$log_2$(Number of days)/2", .75, -.25)
)
flextable::flextable(m) |>
  flextable::add_footer_row(top=FALSE, 
                            values = glue::glue("TBM suspected: > {(qlogis(.304) - a_plot_s$data$m[1] - a_plot_s$data$m[1]*a_plot_s$data$m[7]*4.476003 - a_plot_s$data$m[1]*a_plot_s$data$m[10]*2.241451) |> round(2)}"),
                            colwidths = 3) |>
  ftExtra::colformat_md(j=c(1,3)) |>
  flextable::width(width=1.5) |>
  flextable::theme_vanilla()


```

<!--chapter:end:04-Results.Rmd-->

# Discussions

We implemented the Bayesian Latent Class Analysis for a population of `r nrow(data_19EI)` patients with suspected brain infection through which we estimated the performance of confirmatory assays. Ziehl-Neelsen Smear again prove its superiority over the other two with `r sen('z_Smear')` of sensitivity, similar to prior studies [@nhu2013; @donovan2020]. GeneXpert performed poorly on CSF samples. All test performed significantly better in the HIV positive group, due to higher bacillary burden. With sensitivity and specificity both higher than 90%, either of the three tests can be used as a reliable standard for HIV patients. 

Compared with a recent study [@donovan2020] where the authors used one subset of our data with 305 patients, our estimated sensitivity were lower. In the paper, ZN Smear's sensitivity was estimated to be 71.3%, while MGIT and Xpert were 47.9% and 39.6% respectively. However, stratified by HIV status, our values were more comparable, as the sensitivity of Xpert were 22.9% (12.1% - 39.0%) for HIV negative in the paper (compared to our estimates `r sen('z_Xpert', hiv=FALSE)`) and 76.9% (49.7% - 91.8%) for HIV positive population (compared to our `r sen('z_Xpert', hiv=TRUE)`). This was because the past study targeted on TBM-suspected patients, HIV positive cases were more prevalent.

<!--One important output of the model is the actual TBM risk. Despite being design for research, due to the categorical nature, current TBM studies usually suffer difficulty in which group of patients should be considered as TBM. By providing the risk probability, our model can benefit both. A study of only definite TBM might favour severe patients while a lower group might have more false positive mixed with them. Choosing a cut-off usually comes with large trade-off, as a large group of patient would be excluded or included. By providing a probability, our model can benefit both clinicians and researchers with more clear insight, and more flexible choices of cut-off. In prognosis research, this probability, together with the ordinal quanitification of bacillary burden, can be incorporated as correction parameters for patients' responses to TBM treatment regimen, which is usually quite specific. 
=======
Through the implication of LCA, our model succesfully estimated the positive rates for corresponding confirmation procedures. We founds out that GeneXpert, in combination with Xpert Ultra, was not superior to other confirmatory tests, at least for TBM diagnosis, contrary to its popularity and benefit for pulmonary TB <citation>. Compared to estimations the most recent one [@donovan2020], where the authors used one subset of data with 305 patients, the estimated sensitivity were lower for all three assays, with ZN Smear stood at 67% (compared with 71.3%), MGIT culture 31% (47.9%), and Xpert was 13% (39.6%). We would argue that the latter were against standard uniform definition which is in favor of the confirmatory tests themselves, whereas ours were calculated against the actual TBM status, regardless of the test results. This might also be a suggestion of a small misdiagnosis of TBM when using the current approach, particularly for those with negative test results <may be we can calculate prob TBM in case all test negative to demonstrate this>. This underperfomance was again shown in the calibration plot against discharge diagnosis, with a small dip of observed risk at the around 50%. In fact, we all agree that none amongst the three confirmation indicators are reliable to be used alone as gold standard, and a true gold standard is urgently needed. They, however, all performs well in TBM negative class, with mostly no false positive. These estimations reflect well the biological mechanisms of the tests.
>>>>>>> Stashed changes-->

Our analysis was not the first to use LCA in TBM diagnosis. One study was done in Hanoi, Vietnam [@le2020] used data from the Vietnam National Lung Hospital. Compared with them, our target population was different, as the earlier assumably estimated TBM prevalence amongst general TB, where ours were amongst suspected brain infection. In that study, they assumed all confirmatory tests were independent -- namely two patents with TBM had the same probability of test positive -- which was not necessarily true. Different from past works [@moreira2008; @le2020], non-specific biomarkers were not used as manifest variables in our study but as predictors. Our method was more flexible and allowed us to develop the most highlighted finding: a calibrated scoring system. We witnessed that some used predictors like TB-suggested symptoms and cranial nerve palsy had overestimated scores originally [@marais2010], while HIV was omitted altogether. Laboratory parameters in general followed the same trend as prior knowledge. 

A novel quantification of our model is mycobacterial burden at baseline. Lymphocyte count in CSF intriguingly reduces the mycobacterial burden, which might also led to a less severe long-term prognosis, as pointed out elsewhere [@Thao2018]. Overally, the higher lymphocyte count in CSF, the more likely that the patients have a positive, but milder, TBM. 

All models were rigorously validated. Selected model shows great discrimination and calibration for all three confirmatory tests. Our full model managed to surpass the most sensitive test Smear and our simplified model had comparable sensitivity using only clinical information. The calibration curves against three confirmatory tests showed some drop at the upper tails, particularly for MGIT culturing and Xpert. This drop was due to the scarcity of patients with extreme probability of positive tests. The calibration against the pseudo-gold hospital diagnosis showed some level of overestimation around $x=0.7$. This suggests some misdiagnosis in practice, which motivates us to use the LCA, but might also due to some hidden factors we failed to capture. Further research is required.

This study have some limitations. One major challenges of our model is the amount of missing data, especially test results and HIV status. We had to make several assumptions, and despite the sensitivity analyses (supplementary document), this can underpower the result. No interaction between covariates were considered due to limited sample size so potential association may have been missed.  Another disadvantage is the population from which our sample originated. Our study cohort was patients with suspected neurological infection, which implies some level of arbitrary. Even if that risk is omittable, our TBM prevalence is potentialy overestimated in the general population. Neither in clinical practice nor research field would that be an issue, as usually they are the cohort of interest. However, when doing population surveillance, this must be taken into account; as we would advise against extrapolation under such a circumstance. Rather, it is better to perform a correction basing on neurological infection prevalence. The third issue can come from our model design that is dependent on expertise and accidentally fusing some amount of noise could impact the overall estimates. 

<!--chapter:end:05-Discussions.Rmd-->

# Conclusion

Our model is the first to provide a thorough approach for TBM diagnosis, from admission, to days later with all confirmatory tests, with good discrimination and calibration values. Until a better gold standard being developed, our scoring system can be an objective diagnostic tool and baseline severity estimator in both clinical practice and research for TBM patients.

# References

::: {#refs}
:::

<!--chapter:end:06-Conclusion.Rmd-->

