---
title: 'A novel scoring system to diagnose Tuberculous meningitis using Bayesian Latent class analysis'
author:
  - Trinh Huu Khanh Dong:
      email: trinhdhk@oucru.org
      institute: [oucru, kcl]
      correspondence: yes
  - Joseph Donovan:
      institute: [oucru, lshtm]
  - Thu Dang Anh Do:
      institute: [oucru]
  - Ngoc My Nghiem:
      institute: [oucru, htd]
  - Tan Van Le:
      institute: [oucru, oxford]
  - Thuong Thuong Thuy Nguyen:
      institute: [oucru, oxford]
  - Guy E. Thwaites:
      institute: [oucru, oxford]
  - Ronald B. Geskus:
      institute: [oucru, oxford]
institute:
  - oucru: Oxford University Clinical Research Unit, Centre for Tropical Medicine, Ho Chi Minh City, Viet Nam 
  - kcl: King's College London, United Kingdom
  - lshtm: London School of Hygiene and Tropical Medicine, United Kingdom
  - oxford: Centre for Tropical Medicine and Global Health, Nuffield Department of Medicine, University of Oxford, United Kingdom 
  - htd: Hospital of Tropical Diseases, Ho Chi Minh City, Viet Nam
site: bookdown::bookdown_site
bibliography: includes/references.bib
csl: includes/clinical-infectious-diseases.csl
eqnPrefix: 
  - "Formula"
  - "Formulae"
params:
  dev: "cairo_pdf"
---

```{r setup, include=FALSE}
options(tinytex.engine_args = '-shell-escape')
knitr::opts_chunk$set(echo = FALSE, message=FALSE, dpi=300, dev=params$dev) #, dev = 'png'
flextable::set_flextable_defaults(fonts_ignore=TRUE, font.size=9, table.layout='fixed')
```

```{r library, include=FALSE}
library(gtsummary)
library(dplyr)
library(data.table)
library(magrittr, include.only = '%$%')
library(ggplot2)
library(patchwork)
library(officedown)

# All the misc functions go here.
my_fn <- new.env()

## Add labels accross a tbl
my_fn$add_labels <- \(.data, ...){
  cols <- list(...)
  for (i in seq_along(cols))
    attr(.data[[names(cols)[i]]], 'label') <- cols[[i]]
  .data
}

## Register a knit engine for stan code highlight
my_fn$stan_knitr_engine <- \(options){
  out <- c('\\begin{Shaded}','\\begin{minted}{stan}', options$code, '\\end{minted}','\\end{Shaded}')
  options$echo <- FALSE
  options$results <- "asis"
  knitr::engine_output(options, options$code, out)
}
knitr::knit_engines$set(stan_code = my_fn$stan_knitr_engine)

## Gist to number equations
## https://gist.github.com/mcanouil/eb75057432ff77846f4273d8808e615a
my_fn$is_docx_output <- function (fmt = knitr:::pandoc_to()) {
  if (length(fmt) == 0) {
    return(FALSE)
  } else {
    return(fmt == "docx")
  }
}

my_fn$numberEq.docx <- function (eq, lab, envir = docx.eqcounter) {
  assign(x = "counter", value = get(x = "counter", envir = envir)+1, envir = envir)
  assign(x = gsub("eq:", "", lab), value = get(x = "counter", envir = envir), envir = envir)
  lab <- get("counter", envir = envir)
  return(c('$$', eq, '\\;\\;\\;\\;(', lab, ')', '$$'))
}
my_fn$labEq.docx <- function (lab, envir = docx.eqcounter) {
  return(paste0('(', get(x = gsub("eq:", "", lab), envir = envir), ')'))
}

docx.eqcounter <- new.env()
docx.eqcounter$counter <- 0
  
# Register a knit engine for formula
my_fn$aligned_formula_knit <- \(options){
  out <- my_fn$numberEq.docx(options$code, lab = options$fml.lab)
  options$echo <- FALSE
  options$results <- "asis"
  knitr::engine_output(options, options$code, out)
}
knitr::knit_engines$set(aligned_formula = my_fn$aligned_formula_knit)

# Register diagrammer graphviz
my_fn$diagrammer_engine <- \(options){
   # browser()
  grviz_opt = formals(DiagrammeR::grViz)
  grviz_opt = grviz_opt[names(grviz_opt) != 'diagram']
  new_opt = options[names(options) %in% names(grviz_opt)]
  # not_grviz_opt = opt[!names(opt %in% c('diagram', name(grviz_opt)))]
  grviz_opt = modifyList(grviz_opt, new_opt)
  dia_call <- purrr::partial(DiagrammeR::grViz, diagram = options$code)
  grviz_opt$envir <- parent.frame(9)
  
  out <- do.call(dia_call, grviz_opt) 
  options$code <- out$x$diagram
  options$engine <- 'dot'
  options$echo <- FALSE
  
  knitr::knit_engines$get('dot')(options)
  # options$results <- 'asis'
  # knitr::engine_output(options, options$code, '')
}
knitr::knit_engines$set(diagrammer = my_fn$diagrammer_engine)

# Global theming for ggplots
my_fn$plot_theme <-
  theme(text = element_text('serif', size = 9), 
        plot.tag = element_text('serif', size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

na = \(x) sum(is.na(x))
```

```{r data, include=FALSE}
data_dir <- '../../data/cleaned/'
load(file.path(data_dir, 'data_input.Rdata'))
data_dirty <- readRDS(file.path(data_dir, 'data_dirty.RDS'))
setDT(data_dirty)

# Load model 3's fit and metrics
load(file.path(data_dir, '..', 'export', 'm3_summary.Rdata'))
m3 = readRDS(file.path(data_dir, '..', 'export', 'metrics', 'm3_plot.RDS')) |> as.environment()
m3$p = readRDS(file.path(data_dir, '..', 'export', 'metrics', 'm3p.RDS'))
load(file.path(data_dir, '..', 'export', 'm3_plot.Rdata'), envir = m3)
s_plots <- readRDS(file.path(data_dir, '..', 'export', 'a_plot_s.RDS'))
```

\newpage
